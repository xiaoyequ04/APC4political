---
title: "apc_trust"
format:
  html:
    number-sections: true
editor: visual
---
# packageLoda
```{r Prelode}
#| label: package
#| eval: false
#| echo: false
set.seed(0930)
options (warn = -1)
library(pacman)
p_load("rio",
       "here",
       "tidyverse",
       "haven",
       "car",
       "readxl",
       "countrycode",
       "lmerTest",
       "modelsummary",
       "dotwhisker",
       "ggplot2",
       "optimx",
       "emmeans")
```

# wvs
## dataloda

```{r}
#| lable: wvs
#| eval: false
#| echo: false
# load("../data/wvs/WVST.rdata")
wvs_china <- WVS_TimeSeries_1981_2022_spss_v3_0 %>%
  filter(.,COW_NUM == 710) %>%
  select(.,S002VS,S008,S020,COW_NUM,COW_ALPHA,E069_11,E069_12,E069_08,E069_07,E114,E115,E116,E117,E224,E225,E226,E227,E228,E229,E235,E236,E036,E037,E035,X001,X002,X003,X025,X025R,X045,X047_WVS,X047R_WVS,X007,S017,E023,G006) %>%
  dplyr::rename(
    wave = S002VS,
    period = S020,
    province = S008,
    country_name = COW_ALPHA ,
    country_code = COW_NUM,
    weight = S017,
    yearbirth = X002,
    age = X003
  ) %>%
  mutate(
    across(.cols = where(is.numeric) & !c(country_name,wave,period,country_code,weight,yearbirth),
           ~if_else(.x < 0, NA_real_, .x),
          .names = "{.col}_na")
  ) %>%
  mutate(
    province = substr(province, start = 1, stop = 2)
  )

# rm(WVS_TimeSeries_1981_2022_spss_v3_0)
# wvs_china$agez <- scales::rescale(wvs_china$age,to = c(0,1))
wvs_china$gender <- 2 - wvs_china$X001_na #(0:male;1:female)
wvs_china$edu <- wvs_china$X025R_na
wvs_china$marriage <- Recode(wvs_china$X007_na,"2:6 = 0")
wvs_china$class_sub <- wvs_china$X045_na
wvs_china$socialLevel <- wvs_china$X047_WVS_na
wvs_china$interstpol <-  5 - wvs_china$E023_na

# policticaltrust
wvs_china$trust_gover <- 5 - wvs_china$E069_11_na
wvs_china$trust_gover_max <- Recode(wvs_china$trust_gover,"1:2 = 0; 3:4 = 1")
wvs_china$trust_party <- 5 - wvs_china$E069_12_na
wvs_china$trust_party_max <- Recode(wvs_china$trust_party,"1:2 = 0; 3:4 = 1")
wvs_china$trust_civil <- 5 - wvs_china$E069_08_na
wvs_china$trust_parli <- 5 - wvs_china$E069_07_na


# dem
wvs_china$E226_na[wvs_china$E226_na == 0] <- NA
wvs_china$E224_na[wvs_china$E224_na == 0] <- NA
wvs_china$E227_na[wvs_china$E227_na == 0] <- NA
wvs_china$E229_na[wvs_china$E229_na == 0] <- NA
wvs_china$E224r_na <- Recode(wvs_china$E224_na,"1:5 = 1; 6:10 = 0")
wvs_china$E226r_na <- Recode(wvs_china$E226_na,"1:5 = 0; 6:10 = 1")
wvs_china$E227r_na <- Recode(wvs_china$E227_na,"1:5 = 1; 6:10 = 0")
wvs_china$E229r_na <- Recode(wvs_china$E229_na,"1:5 = 0; 6:10 = 1")

wvs_china$dempro <- wvs_china %>%
  select(.,c(E226_na,E229_na)) %>%
  rowMeans(na.rm = TRUE) 
wvs_china$demuti <- wvs_china %>%
  select(.,c(E224_na,E227_na)) %>%
  rowMeans(na.rm = TRUE)
wvs_china$demscore <- wvs_china %>%
  select(E224r_na,E226r_na,E227r_na,E229r_na) %>%
  rowMeans(na.rm = TRUE)


wvs_china$demimportant <- wvs_china$E235_na
wvs_china$demlevel <- wvs_china$E236_na
wvs_china$leader <- 5 - wvs_china$E114_na
wvs_china$expert <- 5 - wvs_china$E115_na
wvs_china$army <- 5 - wvs_china$E116_na
wvs_china$demelect <- 5 - wvs_china$E117_na


# nationlism
wvs_china$proud <- 5 - wvs_china$G006_na

wvs_china <- wvs_china %>%
  mutate(
    cohort5 = case_when(
      yearbirth %in% c(1905:1948) ~ 1,
      yearbirth %in% c(1949:1954) ~ 2,
      yearbirth %in% c(1955:1959) ~ 3,
      yearbirth %in% c(1960:1964) ~ 4,
      yearbirth %in% c(1965:1969) ~ 5,
      yearbirth %in% c(1970:1974) ~ 6,
      yearbirth %in% c(1975:1979) ~ 7,
      yearbirth %in% c(1980:1984) ~ 8,
      yearbirth %in% c(1985:1989) ~ 9,
      yearbirth %in% c(1990:1994) ~ 10,
      yearbirth %in% c(1995:2000) ~ 11
    ),
    cohort10 = case_when(
      yearbirth %in% c(1905:1948) ~ 1,
      yearbirth %in% c(1949:1958) ~ 2,
      yearbirth %in% c(1959:1968) ~ 3,
      yearbirth %in% c(1969:1978) ~ 4,
      yearbirth %in% c(1979:1988) ~ 5,
      yearbirth %in% c(1989:2000) ~ 6
    )
  )

wvs_china <- wvs_china %>%
  mutate(across(c(period,gender,edu,cohort5,cohort10),as.factor))

write.csv(wvs_china,file = "../data/wvs_china.csv")

```

## dataDesription

```{r}
#| eval: false
#| echo: false
t1_wvs <- modelsummary::datasummary(marriage + class_sub + socialLevel + interstpol + trust_gover + trust_gover_max +  trust_party + trust_party_max + trust_civil + trust_parli + dempro + demuti + demimportant + demlevel + leader + expert + army + proud
  ~ Min + Max + Mean + SD + (Number = N),
  data = wvs_china,
  output = "tinytable",
  title = "WVS Description "
  )
t1_wvs
```

## dataAnalysis
### trust
```{r}
#| eval: false
#| echo: false
lm_gover <- glmer(trust_gover_max ~ agez + gender + edu + interstpol + marriage + class_sub + (1|cohort10) + (1|period),
                  family = binomial,
                  data = wvs_china)
                  weights = weight,
                  # REML = TRUE
                  control = glmerControl(
                    optimizer ='optimx', optCtrl=list(method='L-BFGS-B'))
)
                           
summary(lm_gover)
confint(lm_gover, level = 0.95, method = "Wald")

se <- sqrt(diag(vcov(lm_gover))) #vcov(lm_gover)得到方差矩阵 diag(vcov(lm_gover))提取方差 sqrt(diag(vcov(lm_gover)))求算术平方根，即标准差
z <- -qnorm((1-0.95)/2)

data1 <- exp(cbind(Est=fixef(lm_gover),
  "2.5%"  = fixef(lm_gover) - z*se,
  "97.5%" = fixef(lm_gover) + z*se))
# diag 提取对角线的元素 sqrt() 函数用于计算传递给它的数值的数学平方根
#We transformed back the x axis from "age score" into actual age by adding 2 and then multiplying by 10.
# exp函数用于计算自然对数的底e的幂次方

# (i.e. 0 means the participant is 20 years old, 1 means 30 years old, etc)
# We use a for loop to calculate the probability of weekly cannabis use 
# when the age "score" is between 0 and 5, with 0.5 increment.
# The calculated probability is stored in a new data frame Age_eff

emm <- emmeans(lm_gover,  ~ age + I(age^2))
Age_eff = data.frame()
for (i in 0:10) {
  emm <- emmeans(lm_gover,  ~ ager + I(ager^2),
  at = list(
  ager = i/2, ager2 = (i/2)^2,
  type = "response",
  weights = "outer",
  level = 0.95))
  Age_eff = rbind(data.frame(summary(emm)), Age_eff)
}

# [type = "response"](https://www.r-bloggers.com/2019/03/getting-started-with-emmeans/)的介绍
# 为此，我们可以使用类型参数。使用 type ="response"（响应）将返回原始标度的结果。当转换在模型中是显式的（例如 log(resp)）时，这种方法就会起作用，对于广义线性模型中的链接函数也是如此。

plot_age <- ggplot(Age_eff, aes(x = (ager + 2)*10, y = emmean)) +
    geom_point() + 
    geom_line() +
    geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL), width = 1) +
    xlab("Age") +
    ylab("Probability of weeky cannabis use")
    
plot_age
ggsave(filename = "../fig/effect_age.pdf")

# [ranef](https://wenku.baidu.com/view/aa45e98915fc700abb68a98271fe910ef02dae5a.html?_wkts_=1727773099294) 用来提取模型的随机效应，提取的随机效应可以进一步可视化或者分析。
# 如果模型中有多个随机效应项，可以通过索引来访问。

```

## cohort effect

```{r}
#| eval: false
#| echo: false
lm_cor <- lmerTest::lmer(trust_gover ~ age + I(age^2) + gender + edu + interstpol + marriage + class_sub + (1 | cohort10),
                         data = wvs_china,
                         weights = weight)
lm_per <- lmerTest::lmer(trust_gover ~ age + I(age^2) + gender + edu + interstpol + marriage + class_sub + (1 | period),
                         data = wvs_china,
                         weights = weight)
anova(lm_gover,lm_cor)
anova(lm_gover,lm_per)
```

### 

```{r}
#| eval: false
#| echo: false
lm_gover <- lmerTest::lmer(trust_party ~ agez + gender + edu + interstpol + marriage + class_sub + (1|cohort10) + (1|period),
                  data = wvs_china,
                  weights = weight,
                  # REML = TRUE
                  control = glmerControl(
                    optimizer ='optimx', optCtrl=list(method='L-BFGS-B'))
)

data2 <- wvs_china %>%
  select(.,period,trust_gover,trust_party,trust_party_max)
# Extract the random effect
u0 <- ranef(lm_gover, condVar = TRUE)
names(u0$period) <- "est"
names(u0$cohort10) <- "est"

#Extract the standard error
period_eff <- data.frame(est = u0$period, 
                         se = sqrt(attr(u0[[2]], "postVar")[1, ,]),
                         period = c(2001, 2007, 2013, 2018))
cohort_eff <- data.frame(est = u0$cohort5, 
                         se = sqrt(attr(u0[[1]], "postVar")[1, ,]),
                         cohort = c("1905/1948", 
                                    "1949/1954", 
                                    "1955/1959",
                                    "1960/1964",
                                    "1965/1969",
                                    "1970/1974",
                                    "1975/1979",
                                    "1980/1984",
                                    "1985/1989",
                                    "1990/1994",
                                    "1995/2000"))

cohort_eff <- data.frame(est = u0$cohort10, 
                         se = sqrt(attr(u0[[1]], "postVar")[1, ,]),
                         cohort = c("1905/1948", 
                                    "1949/1958", 
                                    "1959/1968",
                                    "1969/1978",
                                    "1979/1988",
                                    "1989/2000"))

period_eff$upper <- period_eff$est + 1.96*period_eff$se
period_eff$lower <- period_eff$est - 1.96*period_eff$se
cohort_eff$upper <- cohort_eff$est + 1.96*cohort_eff$se
cohort_eff$lower <- cohort_eff$est - 1.96*cohort_eff$se


plot_period <- ggplot(period_eff, aes(x = period, y = est)) +
  geom_point() + 
  geom_errorbar(aes(ymin = lower, ymax = upper), width = .2) + 
  xlab("Year") + 
  ylab("Conditional log odds of the period effect")
plot_period

plot_cohort <- ggplot(cohort_eff, aes(x = cohort, y = est)) +
  geom_point() + 
  geom_errorbar(aes(ymin = lower, ymax = upper), width = .2) + 
  xlab("Cohort") + 
  ylab("Conditional log odds of the cohort effect")
plot_cohort

ggsave(plot_period,file = "../fig/effect_period.pdf")
ggsave(plot_cohort,file = "../fig/effect_cohort.pdf")
```

## Concept

```{r}
#| eval: false
#| echo: false
lm_pro <- lmerTest::lmer(dempro ~ ager + I(ager^2) + gender + edu + interstpol + marriage + class_sub + (1|period),
                         data = wvs_china,
                         weights = weight)
lm_uti <- lmerTest::lmer(demuti ~ ager + I(ager^2) + gender + edu + interstpol + marriage + class_sub + (1|cohort10) + (1|period),
                         data = wvs_china,
                         weights = weight)

lm_uti_per <- lmerTest::lmer(demuti ~ ager + I(ager^2) + gender + edu + interstpol + marriage + class_sub  + (1|period),
                         data = wvs_china,
                         weights = weight)
lm_uti_coh <- lmerTest::lmer(demuti ~ ager + I(ager^2) + gender + edu + interstpol + marriage + class_sub  + (1|cohort10),
                         data = wvs_china,
                         weights = weight)
anova(lm_uti,lm_uti_coh)
anova(lm_uti,lm_uti_per)

lm_pro_per <- lmerTest::lmer(dempro ~ ager + I(ager^2) + gender + edu + interstpol + marriage + class_sub  + (1|period),
                         data = wvs_china,
                         weights = weight)
lm_pro_coh <- lmerTest::lmer(dempro ~ ager + I(ager^2) + gender + edu + interstpol + marriage + class_sub  + (1|cohort10),
                         data = wvs_china,
                         weights = weight)
anova(lm_pro,lm_pro_coh)
anova(lm_pro,lm_pro_per)
```

::: {.callout-tip collapse=false}
1.  S025:country-year
2.  S024:country-wave
3.  S017:weight
4.  X001:gender(1:male 2: female)
5.  X002:year of birth
6.  X003:age
7.  X025R:edu
8.  X007:marriage
9.  X045:人们有时会把自己划分到高低不同的阶层，您认为自己在社会上属于哪一个阶层？1：高层 5:下层 8:不知道
10. X047_WVS：家庭平均收入阶层 1-10 最低-最高
11. X047R_WVS：家庭平均收入阶层(3个组别)
12. E023:您对政治感兴趣吗？1-4 很感兴趣-一点也不 9:不回答
13. E069_11: 对中央政府的信任度
14. E069_12：对党的信任度
15. E069_08: 对行政机关的信任度
16. E069_07：对人大的信任度
17. E114-E117B: 下面我将列举一些不同形式的政治体制，请问假如在我国采用这种政治体制，您认为是非常好、好、不好，还是非常不好？
    -   有一个不受人大选举干扰的强有力的领袖
    -   应该依据专家而不是政府的意见，进行决策
    -   实行军事统治
    -   实行民主政治体制
18. E235: 民主的重要性 1-10
19. E236:我国的民主程度 1-10
20. E224-E229：
    -   政府向富人收税补贴穷人
    -   宗教领袖可以解释法律
    -   人们通过自由选举来选择领导人
    -   政府提供失业救济
    -   当政府无能时军队应该接管
    -   人们的自由不受侵犯是受宪法保护的公民权利

:::




# CBS
## cbs2002

```{r cbs2002, echo=FALSE}
#| label: cbs2002
#| eval: false
#| echo: false
# no socilalevel
cbs2002_raw <- read_dta("../data/cbs/cbs2002.dta") %>%
  mutate(year = 2002,
         wave = 1)
cbs2002_raw[cbs2002_raw < 0] <- NA
cbs2002 <- cbs2002_raw %>%
  dplyr::select(.,q1,province_id,year,wave,v2,v4,v14,v23,v24,v82,v83,v84,v111,v110,v109,v101,v123,v73a,v73b,v73c,v73d,i3c,i4,i5a,i5b,i5c,i5d,i8,v49d,v49m,v58t,w)  %>%
  rename(id = q1,
         province = province_id,
         weight = w)

# area
cbs2002$province <- as.character(cbs2002$province) %>%
  dplyr::recode(
         "11" = "北京市", 
         "12" = "天津市", 
         "13" = "河北省", 
         "14" = "山西省", 
         "15" = "内蒙古自治区", 
         "21" = "辽宁省", 
         "22" = "吉林省", 
         "23" = "黑龙江省", 
         "31" = "上海市", 
         "32" = "江苏省", 
         "33" = "浙江省", 
         "34" = "安徽省", 
         "35" = "福建省", 
         "36" = "江西省", 
         "37" = "山东省", 
         "41" = "河南省", 
         "42" = "湖北省", 
         "43" = "湖南省", 
         "44" = "广东省", 
         "45" = "广西壮族自治区", 
         "46" = "海南省", 
         "50" = "重庆市", 
         "51" = "四川省", 
         "52" = "贵州省", 
         "53" = "云南省", 
         "54" = "西藏自治区", 
         "61" = "陕西省", 
         "62" = "甘肃省", 
         "63" = "青海省", 
         "64" = "宁夏回族自治区", 
         "65" = "新疆维吾尔自治区")

cbs2002$female <- cbs2002$v82 - 1
cbs2002$age <- cbs2002$v83
cbs2002$marriage <- Recode(cbs2002$v123,"9 = NA")
cbs2002$hukouRural <- Recode(cbs2002$v2, "2 = 0; c(3,7) = NA") #0:城镇户口 1:农村户口
cbs2002$race <- Recode(cbs2002$v84, "2:33 = 0; c(0,98) = 0") #1:汉族
cbs2002$party <- Recode(cbs2002$v111,"c(1,2,4,9) = 0; 3 =1") 
cbs2002$edu <- Recode(cbs2002$v110, "0:1 = 1; 2 = 2; 3:4 = 3; 5 = 4; 6 = 5; 9 = NA")
cbs2002$interstpol <- 5 - cbs2002$v14
cbs2002$socialLevel <- Recode(cbs2002$v24,"8:9 = NA")

# political trust
cbs2002$trust_party <- cbs2002$v73d
cbs2002$trust_party_z <- Recode(cbs2002$v73d,"c(0,8,9) = NA") 
cbs2002$trust_party_z <- scales::rescale(as.numeric(cbs2002$trust_party_z),to = c(0,1))
cbs2002$trust_partyR <- Recode(cbs2002$v73d,"1:3 = 0;4:6 = 1; c(0,8,9) = NA") 
cbs2002$trust_party_max <- Recode(cbs2002$v73d,"1:5 = 0; 6 = 1; c(0,8,9) = NA") 

cbs2002$trust_gover <- cbs2002$v73b
cbs2002$trust_gover_z <- Recode(cbs2002$v73b,"c(0,8,9) = NA") 
cbs2002$trust_gover_z <- scales::rescale(as.numeric(cbs2002$trust_gover_z),to = c(0,1)) 
cbs2002$trust_goverR <- Recode(cbs2002$v73b,"4:6 = 1; 1:3 = 0; c(0,8,9) = NA") 
cbs2002$trust_gover_max <- Recode(cbs2002$v73b,"1:5 = 0; 6 = 1;c(0,8,9) = NA")

cbs2002$trust_local <- cbs2002$v73c
cbs2002$trust_local_z <- Recode(cbs2002$v73c,"c(0,8,9) = NA")
cbs2002$trust_local_z <- scales::rescale(as.numeric(cbs2002$trust_local_z),to = c(0,1)) 
cbs2002$trust_local_max <- Recode(cbs2002$v73c,"6 = 1; 1:5 = 0; c(0,8,9) = NA")
cbs2002$trust_localR <- Recode(cbs2002$v73c,"4:6 = 1; 1:3 = 0; c(0,8,9) = NA")


cbs2002$trust_court <- cbs2002$v73a
cbs2002$trust_court_z <- Recode(cbs2002$v73a,"c(0,8,9) = NA") 
cbs2002$trust_court_z <- scales::rescale(as.numeric(cbs2002$trust_court_z),to = c(0,1)) 
cbs2002$trust_courtR <- Recode(cbs2002$v73a,"4:6 = 1; 1:3 = 0; c(0,8,9) = NA")


# dem
cbs2002$demlevel <- cbs2002$i3c
cbs2002$demsuit <- Recode(cbs2002$i4,"98:99 = NA")
cbs2002$demsatisify <- 5 - cbs2002$i8
cbs2002$leader <- Recode(cbs2002$i5a,"8:9 = NA")
cbs2002$expert <- 5 - cbs2002$i5b
cbs2002$compete <- 5 - cbs2002$i5c
cbs2002$army <- 5 - cbs2002$i5d


# nationlism
cbs2002$systembest <- 5 - cbs2002$v49d
cbs2002$systemsuit <- 5 - cbs2002$v49m
cbs2002$lifestyle <- 5 - cbs2002$v58t
# remove NA
cbs2002[cbs2002 < 0] <- NA

cbs2002clean <- cbs2002 %>%
  select(.,id,province,year,weight,age,female,party,edu,interstpol,socialLevel,marriage,trust_party,trust_party_z,trust_partyR,trust_party_max,trust_gover,trust_gover_z,trust_goverR,trust_gover_max,trust_local,trust_local_z,trust_localR,trust_localR,demlevel,demsuit,demsatisify,leader,expert,army,compete,lifestyle,systembest)

# write.csv(cbs2002,file = "../dataclean/cbs2002.csv")
```


## cbs2008

```{r cbs2008}
#| label: cbs2008
#| eval: false
#| echo: false
cbs2008_raw <- haven::read_dta("../data/cbs/cbs2008.dta") %>%
  mutate(year = 2008,
         wave = 1) 
cbs2008_raw[cbs2008_raw < 0] <- NA
cbs2008 <- cbs2008_raw %>%
  dplyr::select(.,number,PROV,year,wave,a1,b1,b6,c3,c9,j1,j2,j3,j3a,j4,j8,j25,j28,j35,f30a,f30b,f30c,f30d,g1n,g1o,h1c,h1n,h3,h9,h11a,h11d,h12,w) %>%
  rename(id = number,
         province = PROV,
         weight = w)

# area
cbs2008$province <- as.character(cbs2008$province) %>%
  dplyr::recode(
         "11" = "北京市", 
         "12" = "天津市", 
         "13" = "河北省", 
         "14" = "山西省", 
         "15" = "内蒙古自治区", 
         "21" = "辽宁省", 
         "22" = "吉林省", 
         "23" = "黑龙江省", 
         "31" = "上海市", 
         "32" = "江苏省", 
         "33" = "浙江省", 
         "34" = "安徽省", 
         "35" = "福建省", 
         "36" = "江西省", 
         "37" = "山东省", 
         "41" = "河南省", 
         "42" = "湖北省", 
         "43" = "湖南省", 
         "44" = "广东省", 
         "45" = "广西壮族自治区", 
         "46" = "海南省", 
         "50" = "重庆市", 
         "51" = "四川省", 
         "52" = "贵州省", 
         "53" = "云南省", 
         "54" = "西藏自治区", 
         "61" = "陕西省", 
         "62" = "甘肃省", 
         "63" = "青海省", 
         "64" = "宁夏回族自治区", 
         "65" = "新疆维吾尔自治区")

cbs2008$female <- cbs2008$j1 - 1
cbs2008$age <- cbs2008$j2
cbs2008$marriage <- Recode(cbs2008$j35,"c(1,3,4,5,6) = 0; 2 = 1; 9 = NA")
cbs2008$hukouRural <- Recode(cbs2008$a1, "2 = 0; c(3,9) = NA") #0:城镇户口 1:农村户口
cbs2008$race <- Recode(cbs2008$j4, "2 = 0; c(98,99) = 0") 
cbs2008$party <- Recode(cbs2008$j28,"1:2 = 0; 3:4 =1; 9 = NA") 
cbs2008$edu <- Recode(cbs2008$j3, "0:1 = 1; 2:3 = 2; 4:6 = 3; 7 = 4; 8 = 5; 9 = NA")
cbs2008$interstpol <- 5 - cbs2008$b6
cbs2008$socialLevel <- Recode(cbs2008$j25,"98:99 = NA")
cbs2008$ecoLevel <- 6 - cbs2008$c9

# political trust
cbs2008$trust_party <- cbs2008$f30d
cbs2008$trust_party_z <- Recode(cbs2008$f30d,"7:9 = NA")
cbs2008$trust_party_z <- scales::rescale(as.numeric(cbs2008$trust_party_z),to = c(0,1))
cbs2008$trust_party_max <- Recode(cbs2008$trust_party,"1:5 = 0; 6 = 1; 7:9 = NA")
cbs2008$trust_partyR <- Recode(cbs2008$trust_party,"1:3 = 0; 4: 6 = 1; 7:9 = NA")

cbs2008$trust_gover <- cbs2008$f30b
cbs2008$trust_gover_z <- Recode(cbs2008$f30b,"7:9 = NA")
cbs2008$trust_gover_z <- scales::rescale(as.numeric(cbs2008$trust_gover_z),to = c(0,1)) 
cbs2008$trust_goverR <- Recode(cbs2008$f30b,"4:6 = 1; 1:3 = 0; 7:9 = NA") 
cbs2008$trust_gover_max <- Recode(cbs2008$f30b,"6 = 1; 1:5 = 0; 7:9 = NA")

cbs2008$trust_local <- cbs2008$f30c
cbs2008$trust_local_z <- Recode(cbs2008$f30c,"7:9 = NA") 
cbs2008$trust_local_z <- scales::rescale(as.numeric(cbs2008$trust_local_z),to = c(0,1)) 
cbs2008$trust_localR <- Recode(cbs2008$f30c,"4:6 = 1; 1:3 = 0; 7:9 = NA")  
cbs2008$trust_local_max <- Recode(cbs2008$f30c,"6 = 1; 1:5 = 0; 7:9 = NA") 

cbs2008$trust_court <- cbs2008$f30a
cbs2008$trust_court_z <- Recode(cbs2008$f30a,"7:9 = NA") 
cbs2008$trust_court_z <- scales::rescale(as.numeric(cbs2008$trust_court_z),to = c(0,1)) 
cbs2008$trust_courtR <- Recode(cbs2008$f30a,"4:6 = 1; 1:3 = 0; 7:9 = NA")

# dem
cbs2008$demlevel <- cbs2008$h11d
cbs2008$demlevel_usa <- cbs2008$h11a
cbs2008$demsuit <- Recode(cbs2008$h12,"98:99 = NA")
cbs2008$demsatisify <- 5 - cbs2008$h9

cbs2008$leader <- 5 - cbs2008$g1n
cbs2008$army <- 5 - cbs2008$g1o

##concept of dem
cbs2008$h3 <- Recode(cbs2008$h3,"1:2 = 1; 3:4 = 0")
  
# nationalism
cbs2008$proud <- 5 - cbs2008$c3
cbs2008$lifestyle <- 5 - cbs2008$h1n
cbs2008$systemsuit <- 5 - cbs2008$h1c


# remove NA
cbs2008[cbs2008 < 0] <- NA
cbs2008clean <- cbs2008 %>%
  select(.,id,province,year,weight,age,female,party,edu,interstpol,socialLevel,marriage,trust_party,trust_party_z,trust_partyR,trust_party_max,trust_gover,trust_gover_z,trust_goverR,trust_gover_max,trust_local,trust_local_z,trust_localR,trust_localR,demlevel,demlevel_usa,demsuit,demsatisify,leader,army,lifestyle,proud)
# write.csv(cbs2008,file = "../dataclean/cbs2008.csv")

```

## cbs2011

```{r cbs2011}
#| label: cbs2011
#| eval: false
#| echo: false
cbs2011_raw <- haven::read_dta("../data/cbs/cbs2011.dta") %>%
  mutate(year = 2011,
         wave = 1) %>%
  rename(id = idnumber,
         province = PROVINCE,
         weight = wCN)
cbs2011_raw[cbs2011_raw < 0] <- NA
cbs2011 <- cbs2011_raw %>%
  select(.,id,province,year,wave,A1,A2,A8,A15,B1,B11a,B11b,B13,C17a,C17h,C17b,C17c,F12,F13,F14,F15,F16,F17,F18,F19,SE1,SE2,SE3,SE4,SE21,SE22,SE29,F7,F8,F9,F10,G1,G2,G6,weight)
cbs2011$province <- as.character(cbs2011$province) %>%
  dplyr::recode(
         "1" = "上海市",
         "2" = "辽宁省",
         "3" = "河南省",
         "4" = "广东省",
         "5" = "甘肃省", 
         "6" = "北京市",
         "7" = "天津市", 
         "8" = "河北省", 
         "9" = "山西省",
         "10" = "吉林省",
         "11" = "黑龙江省",
         "12" = "江苏省",
         "13" = "浙江省", 
         "14" = "安徽省",
         "15" = "福建省",
         "16" = "江西省",
         "17" = "山东省",
         "18" = "湖北省", 
         "19" = "湖南省", 
         "20" = "广西壮族自治区",
         "21" = "重庆市", 
         "22" = "四川省", 
         "23" = "贵州省", 
         "24" = "云南省", 
         "25" = "陕西省") 


cbs2011$female <- cbs2011$SE1 - 1
cbs2011$age <- cbs2011$SE2
cbs2011$hukouRural <- Recode(cbs2011$A1,"2 = 0; c(3,9) = NA")
cbs2011$marriage <- Recode(cbs2011$SE29,"2 = 1; c(1,3,4,5,6) = 0; 9 = NA")
cbs2011$party <- Recode(cbs2011$SE22,"c(1,2,9) = 0;3:4 = 1")
cbs2011$race <- Recode(cbs2011$SE4,"c(98,99,2) = 0")
cbs2011$edu <- Recode(cbs2011$SE3,"0:1 = 1; 2:3 = 2;4:6 = 3; 7 = 4; 8 = 5; 9 = NA")
cbs2011$interstpol <- Recode(cbs2011$A8,"9 = NA")
cbs2011$socialLevel <- Recode(cbs2011$SE21,"98:99 = NA")

# politicaltrust
cbs2011$trust_party <- cbs2011$C17c
cbs2011$trust_party_z <- Recode(cbs2011$C17c,"7:9 = NA")
cbs2011$trust_party_z <- scales::rescale(as.numeric(cbs2011$trust_party_z),to = c(0,1))
cbs2011$trust_partyR <- Recode(cbs2011$C17b,"1:3 = 0;4:6 = 1; 7:9 = NA")
cbs2011$trust_party_max <- Recode(cbs2011$C17b,"6 = 1; 1:5 = 0; 7:9 = NA")

cbs2011$trust_gover <- cbs2011$C17b
cbs2011$trust_gover_z <- Recode(cbs2011$C17b,"7:9 = NA")
cbs2011$trust_gover_z <- scales::rescale(as.numeric(cbs2011$trust_gover_z),to = c(0,1))
cbs2011$trust_goverR <- Recode(cbs2011$C17b,"1:3 = 0;4:6 = 1; 7:9 = NA")
cbs2011$trust_gover_max <- Recode(cbs2011$C17b,"6 = 1; 1:5 = 0; 7:9 = NA")

cbs2011$trust_court <- cbs2011$C17a
cbs2011$trust_court_z <- Recode(cbs2011$C17a,"7:9 = NA")
cbs2011$trust_court_z <- scales::rescale(as.numeric(cbs2011$trust_court_z),to = c(0,1))
cbs2011$trust_courtR <- Recode(cbs2011$C17a,"1:3 = 0; 4:6 = 1; 7:9 = NA")


cbs2011$trust_local <- cbs2011$C17h
cbs2011$trust_local_z <- Recode(cbs2011$C17h,"7:9 = NA")
cbs2011$trust_local_z <- scales::rescale(as.numeric(cbs2011$trust_local_z),to = c(0,1))
cbs2011$trust_localR <- Recode(cbs2011$C17h,"1:3 = 0; 4:6 = 1;7:9 = NA")
cbs2011$trust_local_max <- Recode(cbs2011$C17h,"1:5 = 0; 6 = 1;7:9 = NA")


# dem
cbs2011$demsuit <- Recode(cbs2011$B1,"98:99 = NA")
cbs2011$demlevel <- cbs2011$B11a
cbs2011$demlevel_usa <- cbs2011$B11b
cbs2011$demsatisify <- 5 - cbs2011$B13

cbs2011$leader <- 5 - cbs2011$F16
cbs2011$expert <- 5 - cbs2011$F17
cbs2011$compete <- 5 - cbs2011$F18
cbs2011$army <- 5 - cbs2011$F19

cbs2011$F12 <- Recode(cbs2011$F12,"c(1,3) = 0; c(2,4) = 1; 7:9 = NA")
cbs2011$F13 <- Recode(cbs2011$F13,"c(2,4) = 0; c(1,3) = 1; 7:9 = NA")
cbs2011$F14 <- Recode(cbs2011$F14,"c(1,3) = 0; c(2,4) = 1; 7:9 = NA")
cbs2011$F15 <- Recode(cbs2011$F15,"c(2,4) = 0; c(1,3) = 1; 7:9 = NA")
cbs2011$demscore <- cbs2011 %>%
  select(.,F12,F13,F14,F15) %>%
  rowMeans(na.rm = TRUE)
# nationalism
cbs2011$proud <- 5 - cbs2011$G1
cbs2011$lifestyle <- 5 - cbs2011$G6

# remove NA
cbs2011[cbs2011 < 0] <- NA

cbs2011clean <- cbs2011 %>%
  select(.,id,province,year,weight,age,female,party,edu,interstpol,socialLevel,marriage,trust_party,trust_party_z,trust_partyR,trust_party_max,trust_gover,trust_gover_z,trust_goverR,trust_gover_max,trust_local,trust_local_z,trust_localR,trust_localR,demlevel,demsuit,demsatisify,leader,expert,army,compete,lifestyle,proud,demscore)

```

## cbs2014

```{r cbs2014}
#| label: cbs2014
#| eval: false
#| echo: false

cbs2014_raw <- haven::read_sav("../data/cbs/cbs2014.sav") %>%
  mutate(year = 2014,
         wave = 1)

cbs2014_raw[cbs2014_raw < 0] <- NA
cbs2014 <- cbs2014_raw %>%
  select(.,CASEID,Proid,A1,A2,A3A,A4,B1,B11,B18,B19,C19,F1,F7A,F7B,F9,F10,F11,F12,F22A,F22B,F22C,F22D,SE1,SE1A,SE9,SE17,SE8,SE4,SE3,SE2,E1A,E1B,E1H,year,wave,F20A,F20B,F20C,F20D,H1A,H1B,H1C,H2,H3,H5,postweight) %>%
  rename(id = CASEID,
         province = Proid,
         weight = postweight)
cbs2014$province <- as.character(cbs2014$province) %>%
  dplyr::recode(
         "11" = "北京市", 
         "12" = "天津市", 
         "13" = "河北省", 
         "14" = "山西省", 
         "15" = "内蒙古自治区", 
         "21" = "辽宁省", 
         "22" = "吉林省", 
         "23" = "黑龙江省", 
         "31" = "上海市", 
         "32" = "江苏省", 
         "33" = "浙江省", 
         "34" = "安徽省", 
         "35" = "福建省", 
         "36" = "江西省", 
         "37" = "山东省", 
         "41" = "河南省", 
         "42" = "湖北省", 
         "43" = "湖南省", 
         "44" = "广东省", 
         "45" = "广西壮族自治区", 
         "46" = "海南省", 
         "50" = "重庆市", 
         "51" = "四川省", 
         "52" = "贵州省", 
         "53" = "云南省", 
         "54" = "西藏自治区", 
         "61" = "陕西省", 
         "62" = "甘肃省", 
         "63" = "青海省", 
         "64" = "宁夏回族自治区", 
         "65" = "新疆维吾尔自治区")


cbs2014$female <- Recode(cbs2014$A1,"1 = 0; 2 = 1; 9 = NA") 
cbs2014$age <- cbs2014$A3A
cbs2014$marriage <- Recode(cbs2014$SE17,"c(1,3,4,5,6) = 0; 2 = 1; 9 = NA")
cbs2014$hukouRural <- Recode(cbs2014$A2,"2 = 0; c(3,9) = NA")
cbs2014$race <- Recode(cbs2014$A4,"c(8,9,2) = 0")
cbs2014$edu <- Recode(cbs2014$SE1, "0:1 = 1; 2:3 = 2; 4:6 = 3; 7 = 4;8 = 5; 9 = NA")
cbs2014$party <- Recode(cbs2014$SE9,"3:4 = 1; c(1,2,9) = 0")
cbs2014$socialLevel <- Recode(cbs2014$SE8,"98:99 = NA")
cbs2014$interstpol <- Recode(cbs2014$B11,"9 = NA")
cbs2014$ecolevel <- 6 - cbs2014$B18

# politicaltrust
cbs2014$trust_gover <- cbs2014$E1B
cbs2014$trust_gover_z <- Recode(cbs2014$E1B,"7:9 = NA") 
cbs2014$trust_gover_z <- scales::rescale(as.numeric(cbs2014$trust_gover_z),to = c(0,1)) 
cbs2014$trust_goverR <- Recode(cbs2014$E1B,"4:6 = 1; 1:3 = 0; 7:9 = NA") 
cbs2014$trust_gover_max <- Recode(cbs2014$E1B,"6 = 1; 1:5 = 0; 7:9 = NA")

cbs2014$trust_local <- cbs2014$E1H
cbs2014$trust_local_z <- Recode(cbs2014$E1H,"7:9 = NA") 
cbs2014$trust_local_z <- scales::rescale(as.numeric(cbs2014$trust_local_z),to = c(0,1)) 
cbs2014$trust_localR <- Recode(cbs2014$E1H,"4:6 = 1; 1:3 = 0; 7:9 = NA")
cbs2014$trust_local_max <- Recode(cbs2014$E1H,"6 = 1; 1:5 = 0; 7:9 = NA")

cbs2014$trust_court <- cbs2014$E1A
cbs2014$trust_court_z <- Recode(cbs2014$E1A,"7:9 = NA") 
cbs2014$trust_court_z <- scales::rescale(as.numeric(cbs2014$trust_court_z),to = c(0,1)) 
cbs2014$trust_courtR <- Recode(cbs2014$E1A,"4:6 = 1; 1:3 = 0; 7:9 = NA")

# dem
cbs2014$demsatisify <- 5 - cbs2014$C19
cbs2014$demsuit <- Recode(cbs2014$F1,"98:99 = NA")
cbs2014$demlevel <- cbs2014$F7A
cbs2014$demlevel_usa <- cbs2014$F7B
cbs2014$leader <- 5 - cbs2014$F22A
cbs2014$partyelect <- 5 - cbs2014$F22B
cbs2014$army <- 5 - cbs2014$F22C
cbs2014$expert <- 5 - cbs2014$F22D


## concept of dem
cbs2014$F9 <- Recode(cbs2014$F9,"c(1,3) = 0; c(2,4) = 1; 7:9 = NA")
cbs2014$F10 <- Recode(cbs2014$F10,"c(1,3) = 1; c(2,4) = 0; 7:9 = NA")
cbs2014$F11 <- Recode(cbs2014$F11,"c(1,3) = 0; c(2,4) = 1; 7:9 = NA")
cbs2014$F12 <- Recode(cbs2014$F12,"c(1,3) = 1; c(2,4) = 0; 7:9 = NA")

cbs2014$demscore <- cbs2014 %>%
  select(.,F9,F10,F11,F12) %>%
  rowMeans(na.rm = TRUE)
# nationslism
cbs2014$proud <- 5 - cbs2014$H2
cbs2014$lifestyle <- 5 - cbs2014$H5

# remove NA
cbs2014[cbs2014 < 0] <- NA

cbs2014clean <- cbs2014 %>%
  select(.,id,province,year,weight,age,female,party,edu,interstpol,socialLevel,marriage,trust_gover,trust_gover_z,trust_goverR,trust_gover_max,trust_local,trust_local_z,trust_localR,trust_localR,demlevel,demsuit,demsatisify,leader,expert,army,party,lifestyle,proud,demscore)
# write.csv(cbs2014,file = "../dataclean/cbs2014.csv")
```

## cbs2019

```{r cbs2019}
#| label: cbs2019
#| eval: false
#| echo: false
cbs2019_raw <- haven::read_sav("../data/cbs/cbs2019.sav") %>%
  mutate(year = 2019,
         wave = 1) 

# cbs2019_raw[cbs2019_raw < 0] <- NA

cbs2019 <- cbs2019_raw %>%
  dplyr::select(.,"个案编号",SITEPRO,year,wave,A1,A2,A4A,A5,B1,B9,B18,B19,SE1,SE1A,SE11,SE13,SE22,SE5,E4A,E4B,E4C,E4H,F1,F7A,F7B,F9,F10,F11,F12,F24A,F24B,F24C,F24D,F21A,F21B,F21C,F21D,H1A,H1B,H1C,H2,H3,H5,C19,weight_cn) %>%
  dplyr::rename(province = SITEPRO,
                id = "个案编号",
                weight = weight_cn)

cbs2019$province[cbs2019$province == "上海"] <- "上海市"
cbs2019$province[cbs2019$province == "北京"] <- "北京市"
cbs2019$province[cbs2019$province == "北京"] <- "北京市"
cbs2019$province[cbs2019$province == "重庆"] <- "重庆市"
cbs2019$province[cbs2019$province == "云南"] <- "云南省"
cbs2019$province[cbs2019$province == "吉林"] <- "吉林省"
cbs2019$province[cbs2019$province == "四川"] <- "四川省"
cbs2019$province[cbs2019$province == "安徽"] <- "安徽省"
cbs2019$province[cbs2019$province == "山东"] <- "山东省"
cbs2019$province[cbs2019$province == "江苏"] <- "江苏省"
cbs2019$province[cbs2019$province == "广西"] <- "广西壮族自治区"
cbs2019$province[cbs2019$province == "广东"] <- "广东省"
cbs2019$province[cbs2019$province == "江西"] <- "江西省"
cbs2019$province[cbs2019$province == "河南"] <- "河南省"
cbs2019$province[cbs2019$province == "浙江"] <- "浙江省"
cbs2019$province[cbs2019$province == "湖南"] <- "湖南省"
cbs2019$province[cbs2019$province == "甘肃"] <- "甘肃省"
cbs2019$province[cbs2019$province == "贵州"] <- "贵州省"
cbs2019$province[cbs2019$province == "福建"] <- "福建省"
cbs2019$province[cbs2019$province == "黑龙江"] <- "黑龙江省"


cbs2019$female <- cbs2019$A1 - 1
cbs2019$age <- cbs2019$A4A
cbs2019$marriage <- Recode(cbs2019$SE22,"c(1,3,4,5,6) = 0; 2 = 1")
cbs2019$socialLevel <- cbs2019$SE11
cbs2019$hukouRural <- Recode(cbs2019$A2,"c(2,3) = 0; c(1,4) = 1; c(5,9) = NA")
cbs2019$race <- Recode(cbs2019$A5,"2 = 0")
cbs2019$edu <- Recode(cbs2019$SE1, "0:3 = 1; 4:5 = 2; 6:8 = 3; 9 = 4; 10 = 5")
cbs2019$party <- Recode(cbs2019$SE13,"3:4 = 1; 1:2 = 0")
cbs2019$interstpol <- cbs2019$B9
cbs2019$ecolevel <- 6 - cbs2019$B18


# politicaltrust
cbs2019$trust_party <- cbs2019$E4C
cbs2019$trust_party_z <- scales::rescale(as.numeric(cbs2019$E4C),to = c(0,1))
cbs2019$trust_party_max <- Recode(cbs2019$trust_party,"1:5 = 0; 6 = 1")
cbs2019$trust_partyR <- Recode(cbs2019$E4C,"1:3 = 0; 4:6 = 1")

cbs2019$trust_gover <- cbs2019$E4B
cbs2019$trust_gover_z <- scales::rescale(as.numeric(cbs2019$E4B),to = c(0,1)) 
cbs2019$trust_goverR <- Recode(cbs2019$E4B,"4:6 = 1; 1:3 = 0")
cbs2019$trust_gover_max <- Recode(cbs2019$E4B,"6 = 1; 1:5 = 0")

cbs2019$trust_local <- cbs2019$E4H
cbs2019$trust_local_z <- scales::rescale(as.numeric(cbs2019$E4H),to = c(0,1))
cbs2019$trust_localR <- Recode(cbs2019$E4H,"4:6 = 1; 1:3 = 0")
cbs2019$trust_local_max <- Recode(cbs2019$E4H,"6 = 1; 1:5 = 0")

cbs2019$trust_court <- cbs2019$E4A
cbs2019$trust_court_z <- scales::rescale(as.numeric(cbs2019$E4A),to = c(0,1)) 
cbs2019$trust_courtR <- Recode(cbs2019$E4A,"4:6 = 1; 1:3 = 0")

# dem
cbs2019$demsatisify <- 5 - cbs2019$C19
cbs2019$demsuit <- cbs2019$F1
cbs2019$demlevel <- cbs2019$F7A
cbs2019$demlevel_usa <- cbs2019$F7B
cbs2019$leader <- 5 - cbs2019$F24A
cbs2019$partyelect <- 5 - cbs2019$F24B
cbs2019$army <- 5 - cbs2019$F24C
cbs2019$expert <- 5 - cbs2019$F24D

## concept of dem
cbs2019$F9 <- Recode(cbs2019$F9,"c(1,3) = 0; c(2,4) = 1")
cbs2019$F10 <- Recode(cbs2019$F10,"c(1,3) = 1; c(2,4) = 0; 7 = NA")
cbs2019$F11 <- Recode(cbs2019$F11,"c(1,3) = 0; c(2,4) = 1; 7 = NA")
cbs2019$F12 <- Recode(cbs2019$F12,"c(1,3) = 1; c(2,4) = 0; 7 = NA")
cbs2019$demscore <- cbs2019 %>%
  select(.,F9,F10,F11,F12) %>%
  rowMeans(na.rm = TRUE)
# nationalism
cbs2019$proud <- 5 - cbs2019$H2
cbs2019$lifestyle  <- Recode(cbs2019$H5,"2 = 0")

# remove NA
# cbs2019[cbs2019 < 0] <- NA

cbs2019clean <- cbs2019 %>%
  select(.,id,province,year,weight,age,female,party,edu,interstpol,socialLevel,marriage,trust_party,trust_party_z,trust_partyR,trust_party_max,trust_gover,trust_gover_z,trust_goverR,trust_gover_max,trust_local,trust_local_z,trust_localR,trust_localR,demlevel,demsuit,demsatisify,leader,expert,army,party,lifestyle,proud,demscore)
# write.csv(cbs2019,file = "../dataclean/cbs2019.csv")
```

## datacombine
```{r}

cbs <- cbs2019clean %>%
  bind_rows(.,cbs2014clean) %>%
  bind_rows(.,cbs2011clean) %>%
  bind_rows(.,cbs2008clean) %>%
  bind_rows(.,cbs2002clean)

modelsummary::datasummary(marriage  + socialLevel + interstpol + trust_gover +  trust_party + trust_gover_max + trust_party_max + trust_local  + trust_localR  + demlevel  + demlevel_usa + leader + expert + army + proud + lifestyle + demscore
  ~ Min + Max + Mean + SD + (Number = N),
  data = cbs
  )

cbs$yearbirth <- cbs$year - cbs$age
cbs <- cbs %>%
  mutate(
    cohort5 = case_when(
      yearbirth %in% c(1905:1948) ~ 1,
      yearbirth %in% c(1949:1954) ~ 2,
      yearbirth %in% c(1955:1959) ~ 3,
      yearbirth %in% c(1960:1964) ~ 4,
      yearbirth %in% c(1965:1969) ~ 5,
      yearbirth %in% c(1970:1974) ~ 6,
      yearbirth %in% c(1975:1979) ~ 7,
      yearbirth %in% c(1980:1984) ~ 8,
      yearbirth %in% c(1985:1989) ~ 9,
      yearbirth %in% c(1990:1994) ~ 10,
      yearbirth %in% c(1995:2000) ~ 11
    ),
    cohort10 = case_when(
      yearbirth %in% c(1905:1948) ~ 1,
      yearbirth %in% c(1949:1958) ~ 2,
      yearbirth %in% c(1959:1968) ~ 3,
      yearbirth %in% c(1969:1978) ~ 4,
      yearbirth %in% c(1979:1988) ~ 5,
      yearbirth %in% c(1989:2000) ~ 6
    )
  )

write.csv(cbs,file = "../data/cbs.csv")
```

::: {.callout-tip}
1. 目前对**党的信任**尚未编码，除了2014年没有对党的信任，其他年份都有。
2. 爱国主义除了2002年没有，其他的都有。
:::

## dataAnalysis
### democracy concept
```{r}
#| label: concept
lm_concept <- lmerTest::lmer(demscore ~ age + female + party + edu + interstpol + socialLevel + marriage  + (1|cohort10) + (1|year),
                            data = cbs,
                            weights = weight
                            )
```

#### effect_concept
```{r}
#| label: effect_concpt
# Extract the random effect
u0 <- ranef(lm_concept, condVar = TRUE)
names(u0$year) <- "est"
names(u0$cohort10) <- "est"

#Extract the standard error
period_eff <- data.frame(est = u0$year, 
                         se = sqrt(attr(u0[[2]], "postVar")[1, ,]),
                         period = c(2011, 2014, 2019))
cohort_eff <- data.frame(est = u0$cohort5, 
                         se = sqrt(attr(u0[[1]], "postVar")[1, ,]),
                         cohort = c("1905/1948", 
                                    "1949/1954", 
                                    "1955/1959",
                                    "1960/1964",
                                    "1965/1969",
                                    "1970/1974",
                                    "1975/1979",
                                    "1980/1984",
                                    "1985/1989",
                                    "1990/1994",
                                    "1995/2000"))

cohort_eff <- data.frame(est = u0$cohort10, 
                         se = sqrt(attr(u0[[1]], "postVar")[1, ,]),
                         cohort = c("1905/1948", 
                                    "1949/1958", 
                                    "1959/1968",
                                    "1969/1978",
                                    "1979/1988",
                                    "1989/2000"))

period_eff$upper <- period_eff$est + 1.96*period_eff$se
period_eff$lower <- period_eff$est - 1.96*period_eff$se
cohort_eff$upper <- cohort_eff$est + 1.96*cohort_eff$se
cohort_eff$lower <- cohort_eff$est - 1.96*cohort_eff$se


plot_period <- ggplot(period_eff, aes(x = period, y = est)) +
  geom_point() + 
  geom_errorbar(aes(ymin = lower, ymax = upper), width = .2) + 
  xlab("Year") + 
  ylab("Conditional log odds of the period effect")
plot_period

plot_cohort <- ggplot(cohort_eff, aes(x = cohort, y = est)) +
  geom_point() + 
  geom_errorbar(aes(ymin = lower, ymax = upper), width = .2) + 
  xlab("Cohort") + 
  ylab("Conditional log odds of the cohort effect")
plot_cohort

ggsave(plot_period,file = "../fig/effect_period.pdf")
ggsave(plot_cohort,file = "../fig/effect_cohort.pdf")
```


### dempcracy level


### leader
#### regression_leader
```{r}
#| label: leader
lm_leader <- lmerTest::lmer(leader ~ age + female + party + edu + interstpol + socialLevel + marriage  + (1|cohort10) + (1|year),
                            data = cbs,
                            weights = weight
                            )

```
#### effect_leader
```{r}
#| label: effect_leader
# Extract the random effect
u0 <- ranef(lm_leader, condVar = TRUE)
names(u0$year) <- "est"
names(u0$cohort10) <- "est"

#Extract the standard error
period_eff <- data.frame(est = u0$year, 
                         se = sqrt(attr(u0[[2]], "postVar")[1, ,]),
                         period = c(2002,2008,2011, 2014, 2019))
cohort_eff <- data.frame(est = u0$cohort5, 
                         se = sqrt(attr(u0[[1]], "postVar")[1, ,]),
                         cohort = c("1905/1948", 
                                    "1949/1954", 
                                    "1955/1959",
                                    "1960/1964",
                                    "1965/1969",
                                    "1970/1974",
                                    "1975/1979",
                                    "1980/1984",
                                    "1985/1989",
                                    "1990/1994",
                                    "1995/2000"))

cohort_eff <- data.frame(est = u0$cohort10, 
                         se = sqrt(attr(u0[[1]], "postVar")[1, ,]),
                         cohort = c("1905/1948", 
                                    "1949/1958", 
                                    "1959/1968",
                                    "1969/1978",
                                    "1979/1988",
                                    "1989/2000"))

period_eff$upper <- period_eff$est + 1.96*period_eff$se
period_eff$lower <- period_eff$est - 1.96*period_eff$se
cohort_eff$upper <- cohort_eff$est + 1.96*cohort_eff$se
cohort_eff$lower <- cohort_eff$est - 1.96*cohort_eff$se


plot_period_leader <- ggplot(period_eff, aes(x = period, y = est)) +
  geom_point() + 
  geom_errorbar(aes(ymin = lower, ymax = upper), width = .2) + 
  xlab("Year") + 
  ylab("Conditional log odds of the period effect")
plot_period_leader

plot_cohort_leader <- ggplot(cohort_eff, aes(x = cohort, y = est)) +
  geom_point() + 
  geom_errorbar(aes(ymin = lower, ymax = upper), width = .2) + 
  xlab("Cohort") + 
  ylab("Conditional log odds of the cohort effect")
plot_cohort_leader

ggsave(plot_period,file = "../fig/effect_leader_period.pdf")
ggsave(plot_cohort,file = "../fig/effect_leader_cohort.pdf")
```




