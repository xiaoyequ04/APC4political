---
title: "apc_trust"
format:
  html:
    number-sections: true
editor: visual
code-fold: true # 代码折叠
---
# packageLoda

```{r Prelode}
#| label: package
#| echo: false
set.seed(0930)
options (warn = -1)
library(pacman)
p_load("rio",
       "here",
       "tidyverse",
       "haven",
       "car",
       "readxl",
       "countrycode",
       "lmerTest",
       "modelsummary",
       "dotwhisker",
       "ggplot2",
       "optimx",
       "emmeans",
       "ggpubr",
       "psych")
```

# ECO
```{r}
mds <- haven::read_dta("../data/eco/maddison2023.dta") %>%
  filter(countrycode == "CHN") %>%
  filter(year >= "1900") %>%
  select(.,year,gdppc,pop) %>%
  filter(.,year != "730")
mds_su <- haven::read_dta("../data/eco/gdpData.dta") 
mds_china <- mds %>%
  left_join(.,mds_su)
rm(mds,mds_su)

```

# WVS
## dataloda

```{r}
#| label: wvs
#| eval: false
#| echo: false
# load("../data/wvs/WVST.rdata")
wvs_china <- WVS_TimeSeries_1981_2022_spss_v3_0 %>%
  filter(.,COW_NUM == 710) %>%
  select(.,S002VS,S008,S020,COW_NUM,COW_ALPHA,E069_11,E069_12,E069_08,E069_07,E114,E115,E116,E117,E224,E225,E226,E227,E228,E229,E235,E236,E036,E037,E035,X001,X002,X003,X025,X025R,X045,X047_WVS,X047R_WVS,X007,S017,E023,G006,X052,X051) %>%
  dplyr::rename(
    wave = S002VS,
    period = S020,
    province = S008,
    country_name = COW_ALPHA ,
    country_code = COW_NUM,
    weight = S017,
    yearbirth = X002,
    age = X003
  ) %>%
  mutate(
    across(.cols = where(is.numeric) & !c(country_name,wave,period,country_code,weight,yearbirth),
           ~if_else(.x < 0, NA_real_, .x),
          .names = "{.col}_na")
  ) %>%
  mutate(
    province = substr(province, start = 1, stop = 2)
  )

# rm(WVS_TimeSeries_1981_2022_spss_v3_0)
# wvs_china$agez <- scales::rescale(wvs_china$age,to = c(0,1))
wvs_china$gender <- 2 - wvs_china$X001_na #(0:male;1:female)
wvs_china$edu <- wvs_china$X025R_na
wvs_china$marriage <- Recode(wvs_china$X007_na,"2:6 = 0")
wvs_china$class_sub <- wvs_china$X045_na
wvs_china$socialLevel <- wvs_china$X047_WVS_na
wvs_china$interstpol <-  5 - wvs_china$E023_na
wvs_china$occ <- Recode(wvs_china$X052_na,"2:4 = 0")

# policticaltrust
wvs_china$trust_gover <- 5 - wvs_china$E069_11_na
wvs_china$trust_gover_max <- Recode(wvs_china$trust_gover,"1:2 = 0; 3:4 = 1")
wvs_china$trust_party <- 5 - wvs_china$E069_12_na
wvs_china$trust_party_max <- Recode(wvs_china$trust_party,"1:2 = 0; 3:4 = 1")
wvs_china$trust_civil <- 5 - wvs_china$E069_08_na
wvs_china$trust_parli <- 5 - wvs_china$E069_07_na


# dem
wvs_china$E226_na[wvs_china$E226_na == 0] <- NA
wvs_china$E224_na[wvs_china$E224_na == 0] <- NA
wvs_china$E227_na[wvs_china$E227_na == 0] <- NA
wvs_china$E228_na[wvs_china$E228_na == 0] <- NA
wvs_china$E229_na[wvs_china$E229_na == 0] <- NA
wvs_china$E224r_na <- Recode(wvs_china$E224_na,"1:5 = 1; 6:10 = 0")
wvs_china$E226r_na <- Recode(wvs_china$E226_na,"1:5 = 0; 6:10 = 1")
wvs_china$E227r_na <- Recode(wvs_china$E227_na,"1:5 = 1; 6:10 = 0")
wvs_china$E229r_na <- Recode(wvs_china$E229_na,"1:5 = 0; 6:10 = 1")

wvs_china$dempro <- wvs_china %>%
  select(.,c(E226_na,E229_na)) %>%
  rowMeans(na.rm = TRUE) 
wvs_china$demuti <- wvs_china %>%
  select(.,c(E224_na,E227_na)) %>%
  rowMeans(na.rm = TRUE)

wvs_china$demproz <- scales::rescale(wvs_china$dempro,to = c(0,1))
wvs_china$demutiz <- scales::rescale(wvs_china$demuti,to = c(0,1))

wvs_china$dempror <- wvs_china %>%
  select(.,c(E226r_na,E229r_na)) %>%
  rowMeans(na.rm = TRUE)
wvs_china$demutir <- wvs_china %>%
  select(.,c(E224r_na,E227r_na)) %>%
  rowMeans(na.rm = TRUE)
wvs_china$demscore <- wvs_china %>%
  select(E224r_na,E226r_na,E227r_na,E229r_na) %>%
  rowMeans(na.rm = TRUE)


wvs_china$demimportant <- wvs_china$E235_na
wvs_china$demlevel <- wvs_china$E236_na
wvs_china$leader <- 5 - wvs_china$E114_na
wvs_china$expert <- 5 - wvs_china$E115_na
wvs_china$army <- 5 - wvs_china$E116_na
wvs_china$demelect <- 5 - wvs_china$E117_na


# nationlism
wvs_china$proud <- 5 - wvs_china$G006_na

wvs_china <- wvs_china %>%
  mutate(
    cohort5 = case_when(
      yearbirth %in% c(1905:1948) ~ 1,
      yearbirth %in% c(1949:1954) ~ 2,
      yearbirth %in% c(1955:1959) ~ 3,
      yearbirth %in% c(1960:1964) ~ 4,
      yearbirth %in% c(1965:1969) ~ 5,
      yearbirth %in% c(1970:1974) ~ 6,
      yearbirth %in% c(1975:1979) ~ 7,
      yearbirth %in% c(1980:1984) ~ 8,
      yearbirth %in% c(1985:1989) ~ 9,
      yearbirth %in% c(1990:1994) ~ 10,
      yearbirth %in% c(1995:2000) ~ 11
    ),
    cohort10 = case_when(
      yearbirth %in% c(1905:1948) ~ 1,
      yearbirth %in% c(1949:1958) ~ 2,
      yearbirth %in% c(1959:1968) ~ 3,
      yearbirth %in% c(1969:1978) ~ 4,
      yearbirth %in% c(1979:1988) ~ 5,
      yearbirth %in% c(1989:2000) ~ 6
    ),
    cohort = case_when(
      yearbirth %in% c(1909:1945) ~ 1,
      yearbirth %in% c(1946:1960) ~ 2,
      yearbirth %in% c(1961:1970) ~ 3,
      yearbirth %in% c(1971:1980) ~ 4,
      yearbirth %in% c(1981:2001) ~ 5,
    )
  )

wvs_china <- wvs_china %>%
  mutate(demproH = if_else(dempro > mean(dempro,na.rm = TRUE),1,0),
         demutiH = if_else(demuti > mean(demuti,na.rm = TRUE),1,0),
         hphu = if_else(demproH == "1" & demutiH == "1",1,0),
         lplu = if_else(demproH == "0" & demutiH == "0",1,0),
         hplu = if_else(demproH == "1" & demutiH == "0",1,0),
         lphu = if_else(demproH == "0" & demutiH == "1",1,0)
  )
wvs_china$diffpro2uti <- wvs_china$dempro - wvs_china$demuti

wvs_china <- wvs_china %>%
  mutate(across(c(period,cohort5,cohort10,cohort),as.factor))

# write.csv(wvs_china,file = "../data/wvs_china.csv")

```

## dataDesription

```{r}
#| eval: false
#| echo: false
t1_wvs <- datasummary(marriage + class_sub + socialLevel + interstpol + trust_gover + trust_gover_max +  trust_party + trust_party_max + trust_civil + trust_parli + dempro + demuti + demimportant + demlevel + leader  + proud  + dempror + demutir + demproz + demutiz ~ 
                        as.factor(wave) * (Mean + SD + (Number = N)),
  data = wvs_china,
  # output = "tinytable",
  output = '../table/wvs_des.html',
  title = "WVS Description"
  )

```


## des_concept
```{r}
wvs_china_group <- wvs_china %>%
  group_by(cohort) %>%
  summarise(dempro_group = mean(dempro,na.rm = TRUE),
            demuti_group = mean(demuti,na.rm = TRUE),
            demscore_group = mean(demscore,na.rm = TRUE))

temp <- wvs_china_group %>%
  select(cohort,dempro_group,demuti_group,demscore_group) %>%
  filter(.,cohort != "NA")

p1_pro <- temp %>%
  ggplot(aes(x = cohort, y = dempro_group, group = cohort)) +
  geom_point() 
p1_uti <- temp %>%
  ggplot(aes(x = cohort, y = demuti_group, group = cohort)) +
  geom_point() 
p1_dem <- ggarrange(p1_pro,p1_uti)
ggsave(p1_dem,file = "../fig/demconcept_group.pdf")

```


## RE
### Concept

```{r}
#| eval: false
#| echo: false
lm_pro <- lmerTest::lmer(dempro ~ age + gender + edu + interstpol + marriage + socialLevel + (1|period) +(1|cohort),
                         data = wvs_china,
                         weights = weight)
lm_uti <- update(lm_pro, demuti ~ .)
# lm_pro10 <- update(lm_pro,. ~ . -(1|cohort) + (1|cohort10))



# Extract the random effect
u0_pro <- ranef(lm_pro, condVar = TRUE)
names(u0_pro$period) <- "est_pro"
names(u0_pro$cohort) <- "est_pro"

#Extract the standard error
period_eff_dempro <- data.frame(est_pro = u0_pro$period, 
                         se = sqrt(attr(u0_pro[[2]], "postVar")[1, ,]),
                         period = c(2007, 2013, 2018))
cohort_eff_dempro <- data.frame(est_pro = u0_pro$cohort, 
                         se = sqrt(attr(u0_pro[[1]], "postVar")[1, ,]),
                         cohort = c("1905/1945", 
                                    "1946/1960", 
                                    "1961/1970",
                                    "1971/1980",
                                    "1980/2001"))

period_eff_dempro$upper <- period_eff_dempro$est_pro + 1.96*period_eff_dempro$se
period_eff_dempro$lower <- period_eff_dempro$est_pro - 1.96*period_eff_dempro$se
cohort_eff_dempro$upper <- cohort_eff_dempro$est_pro + 1.96*cohort_eff_dempro$se
cohort_eff_dempro$lower <- cohort_eff_dempro$est_pro - 1.96*cohort_eff_dempro$se


pr_period_pro <- ggplot(period_eff_dempro, aes(x = period, y = est_pro)) +
  geom_point() + 
  geom_errorbar(aes(ymin = lower, ymax = upper), width = .2) + 
  xlab("Year") + 
  ylab("The period effect of Dempro")
pr_period_pro

pr_cohort_pro <- ggplot(cohort_eff_dempro, aes(x = cohort, y = est_pro)) +
  geom_point() + 
  geom_errorbar(aes(ymin = lower, ymax = upper), width = .2) + 
  xlab("Cohort") + 
  ylab("The cohort effect of Dempro")
pr_cohort_pro

```

## FE
```{r}
fm_pro <- lm(dempro ~ age + gender + edu + interstpol + marriage + socialLevel + period + cohort,
             data = wvs_china,
             weights = weight)
# fm_pro10 <- update(fm_pro, .~. -cohort + cohort10)
fm_uti <- update(fm_pro, demuti ~ .)

fm1_cohort_pro <- broom::tidy(fm_pro) %>%
  filter(grepl("^co",term)) %>%
  rename(est = estimate,
         se = std.error,
         cohort = term) %>%
  mutate(upper = est + 1.96*se,
         lower = est - 1.96*se)

fm1_period_pro <- broom::tidy(fm_pro) %>%
  filter(grepl("^per",term)) %>%
  rename(est = estimate,
         se = std.error,
         Period = term) %>%
  mutate(upper = est + 1.96*se,
         lower = est - 1.96*se)

fm1_cohort_uti <- broom::tidy(fm_uti) %>%
  filter(grepl("^co",term)) %>%
  rename(est = estimate,
         se = std.error,
         cohort = term) %>%
  mutate(upper = est + 1.96*se,
         lower = est - 1.96*se)

fm1_period_uti <- broom::tidy(fm_uti) %>%
  filter(grepl("^per",term)) %>%
  rename(est = estimate,
         se = std.error,
         Period = term) %>%
  mutate(upper = est + 1.96*se,
         lower = est - 1.96*se)

pf_cohort_pro <- ggplot(fm1_cohort_pro, aes(x = cohort, y = est)) +
  geom_point() + 
  geom_errorbar(aes(ymin = lower, ymax = upper), width = .15) + 
  scale_y_continuous(limits = c(-2,2)) +
  geom_hline(
    yintercept = 0,
    colour = "grey60",
    linetype = 2) +
  xlab("Cohort") + 
  ylab("The cohort effect of Dempro")
pf_cohort_pro

pf_cohort_uti <- ggplot(fm1_cohort_uti, aes(x = cohort, y = est)) +
  geom_point() + 
  geom_errorbar(aes(ymin = lower, ymax = upper), width = .15) + 
  scale_y_continuous(limits = c(-2,2)) +
  geom_hline(
    yintercept = 0,
    colour = "grey60",
    linetype = 2) +
  xlab("Cohort") + 
  ylab("The cohort effect of Demuti")
pf_cohort_uti

plot_cohort_dempro_wvs <- ggarrange(pr_cohort_pro,
                                    pf_cohort_pro)
pf_cohort_pro2uti_wvs <- ggarrange(pf_cohort_pro,
                                   pf_cohort_uti)

plot_cohort_dempro_wvs

# ggsave(pf_cohort_pro2uti_wvs,file = "../fig/pf_cohort_pro2uti_wvs.pdf")
```

### Period_effect
```{r}
fm1_period_pro$Period <- gsub("^period","",fm1_period_pro$Period)
pf_period_pro <- ggplot(fm1_period_pro, aes(x = as.factor(Period), y = est)) +
  geom_point() + 
  geom_errorbar(aes(ymin = lower, ymax = upper), width = .05) + 
  scale_y_continuous(limits = c(-1,2)) +
  geom_hline(
    yintercept = 0,
    colour = "grey60",
    linetype = 2) +
  xlab("Period") + 
  ylab("The Period effect of Dempro")
pf_period_pro

fm1_period_uti$Period <- gsub("^period","",fm1_period_uti$Period)
pf_period_uti <- ggplot(fm1_period_uti, aes(x = as.factor(Period), y = est)) +
  geom_point() + 
  geom_errorbar(aes(ymin = lower, ymax = upper), width = .05) + 
  # scale_y_continuous(limits = c(-1,2)) +
  geom_hline(
    yintercept = 0,
    colour = "grey60",
    linetype = 2) +
  xlab("Period") + 
  ylab("The Period effect of Demuti")
pf_period_uti

plot_dempro_FE <- ggarrange(
  pf_cohort_pro,
  pf_period_pro
)

plot_demuti_FE <- ggarrange(
  pf_cohort_uti,
  pf_period_uti
)
plot_demuti_FE
```


# CBS
## cbs2002

```{r cbs2002}
#| label: cbs2002
#| echo: false
cbs2002_raw <- read_dta("../data/cbs/cbs2002.dta") %>%
  mutate(year = 2002,
         wave = 1)
cbs2002_raw[cbs2002_raw < 0] <- NA
cbs2002 <- cbs2002_raw %>%
  dplyr::select(.,q1,province_id,year,wave,v2,v4,v14,v23,v24,v82,v83,v84,v111,v110,v109,v101,v123,v73a,v73b,v73c,v73d,i3c,i4,i5a,i5b,i5c,i5d,i8,v49d,v49m,v58t,w,v49g,v49j,v49o,v58j,v74m,v74x,v58u,v74v,v74f,v49q,v17,v18,v20,v21,v11a,v11b,v11c,v11d,v11e,v11f,v11g)  %>%
  rename(id = q1,
         province = province_id,
         weight = w)

# area
cbs2002$province <- as.character(cbs2002$province) %>%
  dplyr::recode(
         "11" = "北京市", 
         "12" = "天津市", 
         "13" = "河北省", 
         "14" = "山西省", 
         "15" = "内蒙古自治区", 
         "21" = "辽宁省", 
         "22" = "吉林省", 
         "23" = "黑龙江省", 
         "31" = "上海市", 
         "32" = "江苏省", 
         "33" = "浙江省", 
         "34" = "安徽省", 
         "35" = "福建省", 
         "36" = "江西省", 
         "37" = "山东省", 
         "41" = "河南省", 
         "42" = "湖北省", 
         "43" = "湖南省", 
         "44" = "广东省", 
         "45" = "广西壮族自治区", 
         "46" = "海南省", 
         "50" = "重庆市", 
         "51" = "四川省", 
         "52" = "贵州省", 
         "53" = "云南省", 
         "54" = "西藏自治区", 
         "61" = "陕西省", 
         "62" = "甘肃省", 
         "63" = "青海省", 
         "64" = "宁夏回族自治区", 
         "65" = "新疆维吾尔自治区")

cbs2002$female <- cbs2002$v82 - 1
cbs2002$age <- cbs2002$v83
cbs2002$marriage <- Recode(cbs2002$v123,"9 = NA")
cbs2002$hukouRural <- Recode(cbs2002$v2, "2 = 0; c(3,7) = NA") #0:城镇户口 1:农村户口
cbs2002$race <- Recode(cbs2002$v84, "2:33 = 0; c(0,98) = 0") #1:汉族
cbs2002$party <- Recode(cbs2002$v111,"c(1,2,4,9) = 0; 3 =1") 
cbs2002$edu <- Recode(cbs2002$v110, "0:1 = 1; 2 = 2; 3:4 = 3; 5 = 4; 6 = 5; 9 = NA")
cbs2002$interstpol <- 5 - cbs2002$v14
cbs2002$frepol <- 6 - cbs2002$v4
cbs2002$socialLevel <- Recode(cbs2002$v24,"8:9 = NA")

cbs2002$ecocountry <- 6 - cbs2002$v17
cbs2002$ecocountry5 <- 6 - cbs2002$v18
cbs2002$ecofamily <- 6 - cbs2002$v20
cbs2002$ecofamily5 <- 6 - cbs2002$v21


# cbs2002 <- cbs2002 %>%
#   mutate(source = case_when(
#     v11a == 1 | v11b == 1 |
#       v11c == 1 | v11d == 1 |
#       v11f == 1 ~ "0",
#     v11e == 1 | v11g == 1 ~ "1"
# ))
# cbs2002$source[cbs2002$source = 9] <- NA
# political trust
cbs2002$trust_party <- cbs2002$v73d
cbs2002$trust_party_z <- Recode(cbs2002$v73d,"c(0,8,9) = NA") 
cbs2002$trust_party_z <- scales::rescale(as.numeric(cbs2002$trust_party_z),to = c(0,1))
cbs2002$trust_partyR <- Recode(cbs2002$v73d,"1:3 = 0;4:6 = 1; c(0,8,9) = NA") 
cbs2002$trust_party_max <- Recode(cbs2002$v73d,"1:5 = 0; 6 = 1; c(0,8,9) = NA") 

cbs2002$trust_gover <- cbs2002$v73b
cbs2002$trust_gover_z <- Recode(cbs2002$v73b,"c(0,8,9) = NA") 
cbs2002$trust_gover_z <- scales::rescale(as.numeric(cbs2002$trust_gover_z),to = c(0,1)) 
cbs2002$trust_goverR <- Recode(cbs2002$v73b,"4:6 = 1; 1:3 = 0; c(0,8,9) = NA") 
cbs2002$trust_gover_max <- Recode(cbs2002$v73b,"1:5 = 0; 6 = 1;c(0,8,9) = NA")

cbs2002$trust_local <- cbs2002$v73c
cbs2002$trust_local_z <- Recode(cbs2002$v73c,"c(0,8,9) = NA")
cbs2002$trust_local_z <- scales::rescale(as.numeric(cbs2002$trust_local_z),to = c(0,1)) 
cbs2002$trust_local_max <- Recode(cbs2002$v73c,"6 = 1; 1:5 = 0; c(0,8,9) = NA")
cbs2002$trust_localR <- Recode(cbs2002$v73c,"4:6 = 1; 1:3 = 0; c(0,8,9) = NA")


cbs2002$trust_court <- cbs2002$v73a
cbs2002$trust_court_z <- Recode(cbs2002$v73a,"c(0,8,9) = NA") 
cbs2002$trust_court_z <- scales::rescale(as.numeric(cbs2002$trust_court_z),to = c(0,1)) 
cbs2002$trust_courtR <- Recode(cbs2002$v73a,"4:6 = 1; 1:3 = 0; c(0,8,9) = NA")


# dem
cbs2002$demlevel <- cbs2002$i3c
cbs2002$demsuit <- Recode(cbs2002$i4,"98:99 = NA")
cbs2002$demsatisify <- 5 - cbs2002$i8
cbs2002$leader <- Recode(cbs2002$i5a,"8:9 = NA")
cbs2002$expert <- 5 - cbs2002$i5b
cbs2002$compete <- 5 - cbs2002$i5c
cbs2002$army <- 5 - cbs2002$i5d


# nationlism
cbs2002$systembest <- 5 - cbs2002$v49d
cbs2002$systemsuit <- 5 - cbs2002$v49m
cbs2002$lifestyle <- 5 - cbs2002$v58t

# authoritarian personality
cbs2002$v49g <- 5 - cbs2002$v49g
cbs2002$v49j <- 5 - cbs2002$v49j
cbs2002$v49o <- 5 - cbs2002$v49o
cbs2002$v58j <- 5 - cbs2002$v58j
cbs2002$v58u <- 5 - cbs2002$v58u
cbs2002$v74m <- 5 - cbs2002$v74m
cbs2002$v74x <- 5 - cbs2002$v74x
cbs2002$v74v <- 5 - cbs2002$v74v
cbs2002$v74f <- 5 - cbs2002$v74f
cbs2002$v49q <- 5 - cbs2002$v49q

cbs2002$autho1 <- cbs2002$v49j
cbs2002$autho2 <- cbs2002$v58j
cbs2002$autho3 <- cbs2002$v58u
cbs2002$autho4 <- cbs2002$v74m
cbs2002$autho5 <- cbs2002$v74x
cbs2002$autho6 <- cbs2002$v49o
cbs2002$autho7 <- cbs2002$v49q
cbs2002$autho8 <- cbs2002$v74f
cbs2002$autho9 <- cbs2002$v74v



# remove NA
cbs2002[cbs2002 < 0] <- NA
cbs2002$autho <- cbs2002 %>%
  select(.,autho1,autho2,autho9) %>%
  rowMeans(na.rm = TRUE)

cbs2002clean <- cbs2002 %>%
  select(.,id,wave,province,year,weight,age,female,party,edu,interstpol,frepol,socialLevel,hukouRural,marriage,trust_party,trust_party_z,trust_partyR,trust_party_max,trust_gover,trust_gover_z,trust_goverR,trust_gover_max,trust_local,trust_local_z,trust_localR,trust_localR,demlevel,demsuit,demsatisify,leader,expert,army,compete,lifestyle,systembest,autho,autho1,autho2,autho3,autho4,autho5,autho6,autho7,autho8,autho9,ecofamily5,ecofamily,ecocountry5,ecocountry)

# write.csv(cbs2002,file = "../dataclean/cbs2002.csv")
```


## cbs2008

```{r cbs2008}
#| label: cbs2008
#| echo: false
cbs2008_raw <- haven::read_dta("../data/cbs/cbs2008.dta") %>%
  mutate(year = 2008,
         wave = 2) 
cbs2008_raw[cbs2008_raw < 0] <- NA
cbs2008 <- cbs2008_raw %>%
  dplyr::select(.,number,PROV,year,wave,a1,b1,b6,c3,c9,j1,j2,j3,j3a,j4,j8,j25,j28,j35,f30a,f30b,f30c,f30d,g1n,g1o,h1c,h1n,h3,h9,h11a,h11d,h12,w,f1e,f1g,f1h,g1m,h1f,h1g,d10k,d10d,c12j,h1j,b2a,b2b,b2c,b2d,b2e,b2f,b2g,c6,c7,c9,c10) %>%
  rename(id = number,
         province = PROV,
         weight = w)
# area
cbs2008$province <- as.character(cbs2008$province) %>%
  dplyr::recode(
         "11" = "北京市", 
         "12" = "天津市", 
         "13" = "河北省", 
         "14" = "山西省", 
         "15" = "内蒙古自治区", 
         "21" = "辽宁省", 
         "22" = "吉林省", 
         "23" = "黑龙江省", 
         "31" = "上海市", 
         "32" = "江苏省", 
         "33" = "浙江省", 
         "34" = "安徽省", 
         "35" = "福建省", 
         "36" = "江西省", 
         "37" = "山东省", 
         "41" = "河南省", 
         "42" = "湖北省", 
         "43" = "湖南省", 
         "44" = "广东省", 
         "45" = "广西壮族自治区", 
         "46" = "海南省", 
         "50" = "重庆市", 
         "51" = "四川省", 
         "52" = "贵州省", 
         "53" = "云南省", 
         "54" = "西藏自治区", 
         "61" = "陕西省", 
         "62" = "甘肃省", 
         "63" = "青海省", 
         "64" = "宁夏回族自治区", 
         "65" = "新疆维吾尔自治区")

cbs2008$female <- cbs2008$j1 - 1
cbs2008$age <- cbs2008$j2
cbs2008$marriage <- Recode(cbs2008$j35,"c(1,3,4,5,6) = 0; 2 = 1; 9 = NA")
cbs2008$hukouRural <- Recode(cbs2008$a1, "2 = 0; c(3,9) = NA") #0:城镇户口 1:农村户口
cbs2008$race <- Recode(cbs2008$j4, "2 = 0; c(98,99) = 0") 
cbs2008$party <- Recode(cbs2008$j28,"1:2 = 0; 3:4 =1; 9 = NA") 
cbs2008$edu <- Recode(cbs2008$j3, "0:1 = 1; 2:3 = 2; 4:6 = 3; 7 = 4; 8 = 5; 9 = NA")
cbs2008$interstpol <- 5 - cbs2008$b6
cbs2008$frepol <- 6 - cbs2008$b1
cbs2008$socialLevel <- Recode(cbs2008$j25,"98:99 = NA")
cbs2008$ecocountry <- 6 - cbs2008$c6
cbs2008$ecocountry5 <- 6 - cbs2008$c7
cbs2008$ecofamily <- 6 - cbs2008$c9
cbs2008$ecofamily5 <- 6 - cbs2008$c10



# cbs2008$source <- dplyr::case_when(
#   cbs2008$b2a == 1 ~ "0",
#   cbs2008$b2b == 1 ~ "0",
#   cbs2008$b2c == 1 ~ "0",
#   cbs2008$b2d == 1 ~ "1",
#   cbs2008$b2e == 1 ~ "1",
#   cbs2008$b2f == 1 ~ "1",
#   cbs2008$b2g == 1 ~ "1")

# political trust
cbs2008$trust_party <- cbs2008$f30d
cbs2008$trust_party_z <- Recode(cbs2008$f30d,"7:9 = NA")
cbs2008$trust_party_z <- scales::rescale(as.numeric(cbs2008$trust_party_z),to = c(0,1))
cbs2008$trust_party_max <- Recode(cbs2008$trust_party,"1:5 = 0; 6 = 1; 7:9 = NA")
cbs2008$trust_partyR <- Recode(cbs2008$trust_party,"1:3 = 0; 4: 6 = 1; 7:9 = NA")

cbs2008$trust_gover <- cbs2008$f30b
cbs2008$trust_gover_z <- Recode(cbs2008$f30b,"7:9 = NA")
cbs2008$trust_gover_z <- scales::rescale(as.numeric(cbs2008$trust_gover_z),to = c(0,1)) 
cbs2008$trust_goverR <- Recode(cbs2008$f30b,"4:6 = 1; 1:3 = 0; 7:9 = NA") 
cbs2008$trust_gover_max <- Recode(cbs2008$f30b,"6 = 1; 1:5 = 0; 7:9 = NA")

cbs2008$trust_local <- cbs2008$f30c
cbs2008$trust_local_z <- Recode(cbs2008$f30c,"7:9 = NA") 
cbs2008$trust_local_z <- scales::rescale(as.numeric(cbs2008$trust_local_z),to = c(0,1)) 
cbs2008$trust_localR <- Recode(cbs2008$f30c,"4:6 = 1; 1:3 = 0; 7:9 = NA")  
cbs2008$trust_local_max <- Recode(cbs2008$f30c,"6 = 1; 1:5 = 0; 7:9 = NA") 

cbs2008$trust_court <- cbs2008$f30a
cbs2008$trust_court_z <- Recode(cbs2008$f30a,"7:9 = NA") 
cbs2008$trust_court_z <- scales::rescale(as.numeric(cbs2008$trust_court_z),to = c(0,1)) 
cbs2008$trust_courtR <- Recode(cbs2008$f30a,"4:6 = 1; 1:3 = 0; 7:9 = NA")

# dem
cbs2008$demlevel <- cbs2008$h11d
cbs2008$demlevel_usa <- cbs2008$h11a
cbs2008$demsuit <- Recode(cbs2008$h12,"98:99 = NA")
cbs2008$demsatisify <- 5 - cbs2008$h9

cbs2008$leader <- 5 - cbs2008$g1n
cbs2008$army <- 5 - cbs2008$g1o

##concept of dem
cbs2008$h3 <- Recode(cbs2008$h3,"1:2 = 1; 3:4 = 0")
  
# nationalism
cbs2008$proud <- 5 - cbs2008$c3
cbs2008$lifestyle <- 5 - cbs2008$h1n
cbs2008$systemsuit <- 5 - cbs2008$h1c

## authoritarian personality
cbs2008$f1e <- 5 - cbs2008$f1e
cbs2008$f1g <- 5 - cbs2008$f1g
cbs2008$f1h <- 5 - cbs2008$f1h
cbs2008$g1m <- 5 - cbs2008$g1m
cbs2008$h1f <- 5 - cbs2008$h1f
cbs2008$h1g <- 5 - cbs2008$h1g
cbs2008$d10k <- 5 - cbs2008$d10k
cbs2008$c12j <- 5 - cbs2008$c12j
cbs2008$h1g <- 5 - cbs2008$h1g
cbs2008$h1j <- 5 - cbs2008$h1j
cbs2008$d10d <- 5 - cbs2008$d10d

cbs2008$autho1 <- cbs2008$h1f
cbs2008$autho2 <- cbs2008$f1g
cbs2008$autho3 <- cbs2008$f1e
cbs2008$autho4 <- cbs2008$d10k
cbs2008$autho5 <- cbs2008$f1h
cbs2008$autho6 <- cbs2008$h1g
cbs2008$autho7 <- cbs2008$c12j
cbs2008$autho8 <- cbs2008$d10d
cbs2008$autho9 <- cbs2008$h1j


# remove NA
cbs2008[cbs2008 < 0] <- NA
cbs2008$autho <- cbs2008 %>%
  select(.,autho1,autho2,autho9) %>%
  rowMeans(na.rm = TRUE)

cbs2008clean <- cbs2008 %>%
  select(.,id,wave,province,year,weight,age,female,party,edu,interstpol,frepol,socialLevel,hukouRural,marriage,trust_party,trust_party_z,trust_partyR,trust_party_max,trust_gover,trust_gover_z,trust_goverR,trust_gover_max,trust_local,trust_local_z,trust_localR,trust_localR,demlevel,demlevel_usa,demsuit,demsatisify,leader,army,lifestyle,proud,autho,autho1,autho2,autho3,autho4,autho5,autho6,autho7,autho8,autho9,ecofamily5,ecofamily,ecocountry,ecocountry5)
# write.csv(cbs2008,file = "../dataclean/cbs2008.csv")
```

## cbs2011

```{r cbs2011}
#| label: cbs2011
#| echo: false
cbs2011_raw <- haven::read_dta("../data/cbs/cbs2011.dta") %>%
  mutate(year = 2011,
         wave = 3) %>%
  rename(id = idnumber,
         province = PROVINCE,
         weight = wCN)
cbs2011_raw[cbs2011_raw < 0] <- NA
cbs2011 <- cbs2011_raw %>%
  select(.,id,province,year,wave,A1,A2,A8,A15,B1,B11a,B11b,B13,C17a,C17h,C17b,C17c,F12,F13,F14,F15,F16,F17,F18,F19,SE1,SE2,SE3,SE4,SE21,SE22,SE29,F7,F8,F9,F10,G1,G2,G6,weight,C11,E3,E4,E5,E9,C3,A18,A22,E8,A4a,A4b,A4c,A4d,A4f,A12,A13,A15,A16)
cbs2011$province <- as.character(cbs2011$province) %>%
  dplyr::recode(
         "1" = "上海市",
         "2" = "辽宁省",
         "3" = "河南省",
         "4" = "广东省",
         "5" = "甘肃省", 
         "6" = "北京市",
         "7" = "天津市", 
         "8" = "河北省", 
         "9" = "山西省",
         "10" = "吉林省",
         "11" = "黑龙江省",
         "12" = "江苏省",
         "13" = "浙江省", 
         "14" = "安徽省",
         "15" = "福建省",
         "16" = "江西省",
         "17" = "山东省",
         "18" = "湖北省", 
         "19" = "湖南省", 
         "20" = "广西壮族自治区",
         "21" = "重庆市", 
         "22" = "四川省", 
         "23" = "贵州省", 
         "24" = "云南省", 
         "25" = "陕西省") 


cbs2011$female <- cbs2011$SE1 - 1
cbs2011$age <- cbs2011$SE2
cbs2011$hukouRural <- Recode(cbs2011$A1,"2 = 0; c(3,9) = NA")
cbs2011$marriage <- Recode(cbs2011$SE29,"2 = 1; c(1,3,4,5,6) = 0; 9 = NA")
cbs2011$party <- Recode(cbs2011$SE22,"c(1,2,9) = 0;3:4 = 1")
cbs2011$race <- Recode(cbs2011$SE4,"c(98,99,2) = 0")
cbs2011$edu <- Recode(cbs2011$SE3,"0:1 = 1; 2:3 = 2;4:6 = 3; 7 = 4; 8 = 5; 9 = NA")
cbs2011$interstpol <- Recode(cbs2011$A8,"9 = NA")
cbs2011$A2 <- Recode(cbs2011$A2,"6 = 5; 9 = NA")
cbs2011$frepol <- 6 - cbs2011$A2
cbs2011$socialLevel <- Recode(cbs2011$SE21,"98:99 = NA")

cbs2011$ecocountry <- 6 - cbs2011$A12
cbs2011$ecocountry5 <- 6 - cbs2011$A13
cbs2011$ecofamily <- 6 - cbs2011$A15
cbs2011$ecofamily5 <- 6 - cbs2011$A16

# cbs2011$source <- case_when(
#   cbs2011$A4a = 1 ~ "0",
#   cbs2011$A4b = 1 ~ "0",
#   cbs2011$A4c = 1 ~ "0",
#   cbs2011$A4d = 1 ~ "1",
#   cbs2011$A4e = 1 ~ "1",
#   cbs2011$A4f = 1 ~ "1",
#   cbs2011$A4g = 1 ~ "1"
# )
# cbs2011$source[cbs2011$source %in% c(7,9)] <- NA

# politicaltrust
cbs2011$trust_party <- cbs2011$C17c
cbs2011$trust_party_z <- Recode(cbs2011$C17c,"7:9 = NA")
cbs2011$trust_party_z <- scales::rescale(as.numeric(cbs2011$trust_party_z),to = c(0,1))
cbs2011$trust_partyR <- Recode(cbs2011$C17b,"1:3 = 0;4:6 = 1; 7:9 = NA")
cbs2011$trust_party_max <- Recode(cbs2011$C17b,"6 = 1; 1:5 = 0; 7:9 = NA")

cbs2011$trust_gover <- cbs2011$C17b
cbs2011$trust_gover_z <- Recode(cbs2011$C17b,"7:9 = NA")
cbs2011$trust_gover_z <- scales::rescale(as.numeric(cbs2011$trust_gover_z),to = c(0,1))
cbs2011$trust_goverR <- Recode(cbs2011$C17b,"1:3 = 0;4:6 = 1; 7:9 = NA")
cbs2011$trust_gover_max <- Recode(cbs2011$C17b,"6 = 1; 1:5 = 0; 7:9 = NA")

cbs2011$trust_court <- cbs2011$C17a
cbs2011$trust_court_z <- Recode(cbs2011$C17a,"7:9 = NA")
cbs2011$trust_court_z <- scales::rescale(as.numeric(cbs2011$trust_court_z),to = c(0,1))
cbs2011$trust_courtR <- Recode(cbs2011$C17a,"1:3 = 0; 4:6 = 1; 7:9 = NA")


cbs2011$trust_local <- cbs2011$C17h
cbs2011$trust_local_z <- Recode(cbs2011$C17h,"7:9 = NA")
cbs2011$trust_local_z <- scales::rescale(as.numeric(cbs2011$trust_local_z),to = c(0,1))
cbs2011$trust_localR <- Recode(cbs2011$C17h,"1:3 = 0; 4:6 = 1;7:9 = NA")
cbs2011$trust_local_max <- Recode(cbs2011$C17h,"1:5 = 0; 6 = 1;7:9 = NA")


# dem
cbs2011$demsuit <- Recode(cbs2011$B1,"98:99 = NA")
cbs2011$demlevel <- cbs2011$B11a
cbs2011$demlevel_usa <- cbs2011$B11b
cbs2011$demsatisify <- 5 - cbs2011$B13

cbs2011$leader <- 5 - cbs2011$F16
cbs2011$expert <- 5 - cbs2011$F17
cbs2011$compete <- 5 - cbs2011$F18
cbs2011$army <- 5 - cbs2011$F19

cbs2011$F12 <- Recode(cbs2011$F12,"c(1,3) = 0; c(2,4) = 1; 7:9 = NA")
cbs2011$F13 <- Recode(cbs2011$F13,"c(2,4) = 0; c(1,3) = 1; 7:9 = NA")
cbs2011$F14 <- Recode(cbs2011$F14,"c(1,3) = 0; c(2,4) = 1; 7:9 = NA")
cbs2011$F15 <- Recode(cbs2011$F15,"c(2,4) = 0; c(1,3) = 1; 7:9 = NA")
cbs2011$demscore <- cbs2011 %>%
  select(.,F12,F13,F14,F15) %>%
  rowMeans(na.rm = TRUE)
# nationalism
cbs2011$proud <- 5 - cbs2011$G1
cbs2011$lifestyle <- 5 - cbs2011$G6

## authority
cbs2011$C3 <- 5 - cbs2011$C3
cbs2011$C11 <- 5 - cbs2011$C11
cbs2011$E3 <- 5 - cbs2011$E3
cbs2011$E4 <- 5 - cbs2011$E4
cbs2011$E5 <- 5 - cbs2011$E5
cbs2011$E9 <- 5 - cbs2011$E9
cbs2011$A18 <- 5 - cbs2011$A18
cbs2011$A22 <- 5 - cbs2011$A22
cbs2011$E8 <- 5 - cbs2011$E8

cbs2011$autho1 <- cbs2011$E3
cbs2011$autho2 <- cbs2011$C11
cbs2011$autho3 <- cbs2011$C3
cbs2011$autho4 <- cbs2011$E4
cbs2011$autho5 <- cbs2011$E9
cbs2011$autho6 <- cbs2011$E5
cbs2011$autho7 <- cbs2011$A18
cbs2011$autho8 <- cbs2011$A22
cbs2011$autho9 <- cbs2011$E8



# remove NA
cbs2011[cbs2011 < 0] <- NA

cbs2011$autho <- cbs2011 %>%
  select(.,autho1,autho2,autho9) %>%
  rowMeans(na.rm = TRUE)

cbs2011clean <- cbs2011 %>%
  select(.,id,wave,province,year,weight,age,female,party,edu,interstpol,frepol,socialLevel,hukouRural,marriage,trust_party,trust_party_z,trust_partyR,trust_party_max,trust_gover,trust_gover_z,trust_goverR,trust_gover_max,trust_local,trust_local_z,trust_localR,trust_localR,demlevel,demlevel_usa,demsuit,demsatisify,leader,expert,army,compete,lifestyle,proud,demscore,autho,autho1,autho2,autho3,autho4,autho5,autho6,autho7,autho8,autho9,ecofamily5,ecofamily,ecocountry,ecocountry5)

```

## cbs2014

```{r cbs2014}
#| label: cbs2014
#| echo: false

cbs2014_raw <- haven::read_sav("../data/cbs/cbs2014.sav") %>%
  mutate(year = 2014,
         wave = 4)

cbs2014_raw[cbs2014_raw < 0] <- NA
cbs2014 <- cbs2014_raw %>%
  select(.,CASEID,Proid,A1,A2,A3A,A4,B1,B11,B18,B19,C19,F1,F7A,F7B,F9,F10,F11,F12,F22A,F22B,F22C,F22D,SE1,SE1A,SE9,SE17,SE8,SE4,SE3,SE2,E1A,E1B,E1H,year,wave,F20A,F20B,F20C,F20D,H1A,H1B,H1C,H2,H3,H5,postweight,F19A,F19C,F19D,F19E,F19I,F19K,F19H,D3G,D3F,F19H,B15,B16,B18,B19,B8) %>%
  rename(id = CASEID,
         province = Proid,
         weight = postweight)
cbs2014$province <- as.character(cbs2014$province) %>%
  dplyr::recode(
         "11" = "北京市", 
         "12" = "天津市", 
         "13" = "河北省", 
         "14" = "山西省", 
         "15" = "内蒙古自治区", 
         "21" = "辽宁省", 
         "22" = "吉林省", 
         "23" = "黑龙江省", 
         "31" = "上海市", 
         "32" = "江苏省", 
         "33" = "浙江省", 
         "34" = "安徽省", 
         "35" = "福建省", 
         "36" = "江西省", 
         "37" = "山东省", 
         "41" = "河南省", 
         "42" = "湖北省", 
         "43" = "湖南省", 
         "44" = "广东省", 
         "45" = "广西壮族自治区", 
         "46" = "海南省", 
         "50" = "重庆市", 
         "51" = "四川省", 
         "52" = "贵州省", 
         "53" = "云南省", 
         "54" = "西藏自治区", 
         "61" = "陕西省", 
         "62" = "甘肃省", 
         "63" = "青海省", 
         "64" = "宁夏回族自治区", 
         "65" = "新疆维吾尔自治区")


cbs2014$female <- Recode(cbs2014$A1,"1 = 0; 2 = 1; 9 = NA") 
cbs2014$age <- cbs2014$A3A
cbs2014$marriage <- Recode(cbs2014$SE17,"c(1,3,4,5,6) = 0; 2 = 1; 9 = NA")
cbs2014$hukouRural <- Recode(cbs2014$A2,"2 = 0; c(3,9) = NA")
cbs2014$race <- Recode(cbs2014$A4,"c(8,9,2) = 0")
cbs2014$edu <- Recode(cbs2014$SE1, "0:1 = 1; 2:3 = 2; 4:6 = 3; 7 = 4;8 = 5; 9 = NA")
cbs2014$party <- Recode(cbs2014$SE9,"3:4 = 1; c(1,2,9) = 0")
cbs2014$socialLevel <- Recode(cbs2014$SE8,"98:99 = NA")
cbs2014$interstpol <- Recode(cbs2014$B11,"9 = NA")
cbs2014$B1 <- Recode(cbs2014$B1,"6 = 5; 9 = NA")
cbs2014$frepol <- 6 - cbs2014$B1
cbs2014$ecocountry <- 6 - cbs2014$B15
cbs2014$ecocountry5 <- 6 - cbs2014$B16
cbs2014$ecofamily <- 6 - cbs2014$B18
cbs2014$ecofamily5 <- 6 - cbs2014$B19

# cbs2014$source <- Recode(cbs2014$B8,"c(1,3,4) = 0; c(2,5,6,7,8) = 1; 98:99 = NA")

# politicaltrust
cbs2014$trust_gover <- cbs2014$E1B
cbs2014$trust_gover_z <- Recode(cbs2014$E1B,"7:9 = NA") 
cbs2014$trust_gover_z <- scales::rescale(as.numeric(cbs2014$trust_gover_z),to = c(0,1)) 
cbs2014$trust_goverR <- Recode(cbs2014$E1B,"4:6 = 1; 1:3 = 0; 7:9 = NA") 
cbs2014$trust_gover_max <- Recode(cbs2014$E1B,"6 = 1; 1:5 = 0; 7:9 = NA")

cbs2014$trust_local <- cbs2014$E1H
cbs2014$trust_local_z <- Recode(cbs2014$E1H,"7:9 = NA") 
cbs2014$trust_local_z <- scales::rescale(as.numeric(cbs2014$trust_local_z),to = c(0,1)) 
cbs2014$trust_localR <- Recode(cbs2014$E1H,"4:6 = 1; 1:3 = 0; 7:9 = NA")
cbs2014$trust_local_max <- Recode(cbs2014$E1H,"6 = 1; 1:5 = 0; 7:9 = NA")

cbs2014$trust_court <- cbs2014$E1A
cbs2014$trust_court_z <- Recode(cbs2014$E1A,"7:9 = NA") 
cbs2014$trust_court_z <- scales::rescale(as.numeric(cbs2014$trust_court_z),to = c(0,1)) 
cbs2014$trust_courtR <- Recode(cbs2014$E1A,"4:6 = 1; 1:3 = 0; 7:9 = NA")

# dem
cbs2014$demsatisify <- 5 - cbs2014$C19
cbs2014$demsuit <- Recode(cbs2014$F1,"98:99 = NA")
cbs2014$demlevel <- cbs2014$F7A
cbs2014$demlevel_usa <- cbs2014$F7B
cbs2014$leader <- 5 - cbs2014$F22A
cbs2014$partyelect <- 5 - cbs2014$F22B
cbs2014$army <- 5 - cbs2014$F22C
cbs2014$expert <- 5 - cbs2014$F22D


## concept of dem
cbs2014$F9 <- Recode(cbs2014$F9,"c(1,3) = 0; c(2,4) = 1; 7:9 = NA")
cbs2014$F10 <- Recode(cbs2014$F10,"c(1,3) = 1; c(2,4) = 0; 7:9 = NA")
cbs2014$F11 <- Recode(cbs2014$F11,"c(1,3) = 0; c(2,4) = 1; 7:9 = NA")
cbs2014$F12 <- Recode(cbs2014$F12,"c(1,3) = 1; c(2,4) = 0; 7:9 = NA")

cbs2014$demscore <- cbs2014 %>%
  select(.,F9,F10,F11,F12) %>%
  rowMeans(na.rm = TRUE)
# nationslism
cbs2014$proud <- 5 - cbs2014$H2
cbs2014$lifestyle <- 5 - cbs2014$H5

## authority
cbs2014$D3G <- 5 - cbs2014$D3G
cbs2014$F19A <- 5 - cbs2014$F19A
cbs2014$F19C <- 5 - cbs2014$F19C
cbs2014$F19D <- 5 - cbs2014$F19D
cbs2014$F19E <- 5 - cbs2014$F19E
cbs2014$F19I <- 5 - cbs2014$F19I
cbs2014$F19H <- 5 - cbs2014$F19H
cbs2014$D3F <- 5 - cbs2014$D3F

cbs2014$autho1 <- cbs2014$F19C
cbs2014$autho2 <- cbs2014$F19A
cbs2014$autho3 <- cbs2014$D3G
cbs2014$autho4 <- cbs2014$F19D
cbs2014$autho5 <- cbs2014$F19I
cbs2014$autho6 <- cbs2014$F19E
cbs2014$autho8 <- cbs2014$D3F
cbs2014$autho9 <- cbs2014$F19H
#!没有autho7

# remove NA
cbs2014[cbs2014 < 0] <- NA

cbs2014$autho <- cbs2014 %>%
  select(.,autho1,autho2,autho9) %>%
  rowMeans(na.rm = TRUE)

cbs2014clean <- cbs2014 %>%
  select(.,id,wave,province,year,weight,age,female,party,edu,interstpol,frepol,socialLevel,hukouRural,marriage,trust_gover,trust_gover_z,trust_goverR,trust_gover_max,trust_local,trust_local_z,trust_localR,trust_localR,demlevel,demlevel_usa,demsuit,demsatisify,leader,expert,army,party,lifestyle,proud,demscore,autho,autho2,autho3,autho4,autho5,autho6,autho8,autho9,ecofamily5,ecofamily,ecocountry,ecocountry5)
# write.csv(cbs2014,file = "../dataclean/cbs2014.csv")
```

## cbs2019

```{r cbs2019}
#| label: cbs2019
#| echo: false
cbs2019_raw <- haven::read_sav("../data/cbs/cbs2019.sav") %>%
  mutate(year = 2019,
         wave = 5) 

# cbs2019_raw[cbs2019_raw < 0] <- NA

cbs2019 <- cbs2019_raw %>%
  dplyr::select(.,"个案编号",SITEPRO,year,wave,A1,A2,A4A,A5,B1,B9,B18,B19,SE1,SE1A,SE11,SE13,SE22,SE5,E4A,E4B,E4C,E4H,F1,F7A,F7B,F9,F10,F11,F12,F24A,F24B,F24C,F24D,F21A,F21B,F21C,F21D,H1A,H1B,H1C,H2,H3,H5,C19,weight_cn,F20A,F20C,F20D,F20E,F20I,F20K,F20H,D3G,D3F,F20H,B5,B15,B16,B18,B19) %>%
  dplyr::rename(province = SITEPRO,
                id = "个案编号",
                weight = weight_cn)

cbs2019$province[cbs2019$province == "上海"] <- "上海市"
cbs2019$province[cbs2019$province == "北京"] <- "北京市"
cbs2019$province[cbs2019$province == "北京"] <- "北京市"
cbs2019$province[cbs2019$province == "重庆"] <- "重庆市"
cbs2019$province[cbs2019$province == "云南"] <- "云南省"
cbs2019$province[cbs2019$province == "吉林"] <- "吉林省"
cbs2019$province[cbs2019$province == "四川"] <- "四川省"
cbs2019$province[cbs2019$province == "安徽"] <- "安徽省"
cbs2019$province[cbs2019$province == "山东"] <- "山东省"
cbs2019$province[cbs2019$province == "江苏"] <- "江苏省"
cbs2019$province[cbs2019$province == "广西"] <- "广西壮族自治区"
cbs2019$province[cbs2019$province == "广东"] <- "广东省"
cbs2019$province[cbs2019$province == "江西"] <- "江西省"
cbs2019$province[cbs2019$province == "河南"] <- "河南省"
cbs2019$province[cbs2019$province == "浙江"] <- "浙江省"
cbs2019$province[cbs2019$province == "湖南"] <- "湖南省"
cbs2019$province[cbs2019$province == "甘肃"] <- "甘肃省"
cbs2019$province[cbs2019$province == "贵州"] <- "贵州省"
cbs2019$province[cbs2019$province == "福建"] <- "福建省"
cbs2019$province[cbs2019$province == "黑龙江"] <- "黑龙江省"


cbs2019$female <- cbs2019$A1 - 1
cbs2019$age <- cbs2019$A4A
cbs2019$marriage <- Recode(cbs2019$SE22,"c(1,3,4,5,6) = 0; 2 = 1")
cbs2019$socialLevel <- cbs2019$SE11
cbs2019$hukouRural <- Recode(cbs2019$A2,"c(2,3) = 0; c(1,4) = 1; c(5,9) = NA")
cbs2019$race <- Recode(cbs2019$A5,"2 = 0")
cbs2019$edu <- Recode(cbs2019$SE1, "0:3 = 1; 4:5 = 2; 6:8 = 3; 9 = 4; 10 = 5")
cbs2019$party <- Recode(cbs2019$SE13,"3:4 = 1; 1:2 = 0")
cbs2019$interstpol <- cbs2019$B9
cbs2019$B1 <- Recode(cbs2019$B1,"6 = 5")
cbs2019$frepol <- 6 - cbs2019$B1
cbs2019$ecofamily <- 6 - cbs2019$B18
cbs2019$ecofamily5 <- 6 - cbs2019$B19
cbs2019$ecocountry <- 6 - cbs2019$B15
cbs2019$ecocountry5 <- 6 - cbs2019$B16
cbs2019$inertnet <- Recode(cbs2019$B5,"c(1,3,4) = 0;c(2,5,6,7,8,9) = 1")


# politicaltrust
cbs2019$trust_party <- cbs2019$E4C
cbs2019$trust_party_z <- scales::rescale(as.numeric(cbs2019$E4C),to = c(0,1))
cbs2019$trust_party_max <- Recode(cbs2019$trust_party,"1:5 = 0; 6 = 1")
cbs2019$trust_partyR <- Recode(cbs2019$E4C,"1:3 = 0; 4:6 = 1")

cbs2019$trust_gover <- cbs2019$E4B
cbs2019$trust_gover_z <- scales::rescale(as.numeric(cbs2019$E4B),to = c(0,1)) 
cbs2019$trust_goverR <- Recode(cbs2019$E4B,"4:6 = 1; 1:3 = 0")
cbs2019$trust_gover_max <- Recode(cbs2019$E4B,"6 = 1; 1:5 = 0")

cbs2019$trust_local <- cbs2019$E4H
cbs2019$trust_local_z <- scales::rescale(as.numeric(cbs2019$E4H),to = c(0,1))
cbs2019$trust_localR <- Recode(cbs2019$E4H,"4:6 = 1; 1:3 = 0")
cbs2019$trust_local_max <- Recode(cbs2019$E4H,"6 = 1; 1:5 = 0")

cbs2019$trust_court <- cbs2019$E4A
cbs2019$trust_court_z <- scales::rescale(as.numeric(cbs2019$E4A),to = c(0,1)) 
cbs2019$trust_courtR <- Recode(cbs2019$E4A,"4:6 = 1; 1:3 = 0")

# dem
cbs2019$demsatisify <- 5 - cbs2019$C19
cbs2019$demsuit <- cbs2019$F1
cbs2019$demlevel <- cbs2019$F7A
cbs2019$demlevel_usa <- cbs2019$F7B
cbs2019$leader <- 5 - cbs2019$F24A
cbs2019$partyelect <- 5 - cbs2019$F24B
cbs2019$army <- 5 - cbs2019$F24C
cbs2019$expert <- 5 - cbs2019$F24D

## concept of dem
cbs2019$F9 <- Recode(cbs2019$F9,"c(1,3) = 0; c(2,4) = 1")
cbs2019$F10 <- Recode(cbs2019$F10,"c(1,3) = 1; c(2,4) = 0; 7 = NA")
cbs2019$F11 <- Recode(cbs2019$F11,"c(1,3) = 0; c(2,4) = 1; 7 = NA")
cbs2019$F12 <- Recode(cbs2019$F12,"c(1,3) = 1; c(2,4) = 0; 7 = NA")
cbs2019$demscore <- cbs2019 %>%
  select(.,F9,F10,F11,F12) %>%
  rowMeans(na.rm = TRUE)
# nationalism
cbs2019$proud <- 5 - cbs2019$H2
cbs2019$lifestyle  <- Recode(cbs2019$H5,"2 = 0")


# authority
cbs2019$D3G <- 5 - cbs2019$D3G
cbs2019$F20A <- 5 - cbs2019$F20A
cbs2019$F20C <- 5 - cbs2019$F20C
cbs2019$F20D <- 5 - cbs2019$F20D
cbs2019$F20E <- 5 - cbs2019$F20E
cbs2019$F20I <- 5 - cbs2019$F20I
cbs2019$F20E <- 5 - cbs2019$F20E
cbs2019$F20H <- 5 - cbs2019$F20H
cbs2019$D3F <- 5 - cbs2019$D3F

cbs2019$autho1 <- cbs2019$F20C
cbs2019$autho2 <- cbs2019$F20A
cbs2019$autho3 <- cbs2019$D3G
cbs2019$autho4 <- cbs2019$F20D
cbs2019$autho5 <- cbs2019$F20I
cbs2019$autho6 <- cbs2019$F20E
cbs2019$autho8 <- cbs2019$D3F
cbs2019$autho9 <- cbs2019$F20H

# remove NA
# cbs2019[cbs2019 < 0] <- NA

cbs2019$autho <- cbs2019 %>%
  select(.,autho1,autho2,autho9) %>%
  rowMeans(na.rm = TRUE)
  
cbs2019clean <- cbs2019 %>%
  select(.,id,province,year,weight,age,female,party,edu,interstpol,frepol,socialLevel,hukouRural,marriage,trust_party,trust_party_z,trust_partyR,trust_party_max,trust_gover,trust_gover_z,trust_goverR,trust_gover_max,trust_local,trust_local_z,trust_localR,trust_localR,demlevel,demlevel_usa,demsuit,demsatisify,leader,expert,army,party,lifestyle,proud,demscore,autho,autho1,autho2,autho3,autho4,autho5,autho6,autho8,autho9,ecofamily5,ecofamily,ecocountry,ecocountry5)
```


## datacombine
```{r}
#| label: cbs data

cbs <- cbs2019clean %>%
  bind_rows(.,cbs2014clean) %>%
  bind_rows(.,cbs2011clean) %>%
  bind_rows(.,cbs2008clean) %>%
  bind_rows(.,cbs2002clean) 

cbs$yearbirth <- cbs$year - cbs$age
cbs$demscorer <- ifelse(cbs$demscore > mean(cbs$demscore,na.rm = TRUE),1,0)
cbs$demdiff <- cbs$demlevel - cbs$demlevel_usa
cbs$year <- as.factor(cbs$year)
cbs <- cbs %>%
  mutate(
    cohort5 = case_when(
      yearbirth %in% c(1905:1948) ~ 1,
      yearbirth %in% c(1949:1954) ~ 2,
      yearbirth %in% c(1955:1959) ~ 3,
      yearbirth %in% c(1960:1964) ~ 4,
      yearbirth %in% c(1965:1969) ~ 5,
      yearbirth %in% c(1970:1974) ~ 6,
      yearbirth %in% c(1975:1979) ~ 7,
      yearbirth %in% c(1980:1984) ~ 8,
      yearbirth %in% c(1985:1989) ~ 9,
      yearbirth %in% c(1990:1994) ~ 10,
      yearbirth %in% c(1995:2001) ~ 11
    ),
    cohort10 = case_when(
      yearbirth %in% c(1905:1948) ~ 1,
      yearbirth %in% c(1949:1958) ~ 2,
      yearbirth %in% c(1959:1968) ~ 3,
      yearbirth %in% c(1969:1978) ~ 4,
      yearbirth %in% c(1979:1988) ~ 5,
      yearbirth %in% c(1989:2001) ~ 6
    ),
    cohort = case_when(
      yearbirth %in% c(1905:1945) ~ 1,
      yearbirth %in% c(1946:1960) ~ 2,
      yearbirth %in% c(1961:1970) ~ 3,
      yearbirth %in% c(1971:1980) ~ 4,
      yearbirth %in% c(1981:2001) ~ 5,
    )
  )


 # write.csv(cbs,file = "../data/cbs.csv")


t2_cbs <- modelsummary::datasummary(
  (Marriage = marriage)  + 
  (SocialLevel = socialLevel) + 
  (Interstpol = interstpol) +
  (GoverTrust = trust_gover)  +
  (PartyTrust = trust_party) +
  (GoverTrust_Max = trust_gover_max) +
  (PartyTrust_Max = trust_party_max) +
  (Leader = leader) +
  (Demsatisify = demsatisify) +
  (Demscore = demscore) +
  (Demlevel_china = demlevel) +
  (Demlevel_usa = demlevel_usa) +
  (Ecocountry5 = ecocountry5) +
  (Ecocountry = ecocountry) +
  (Ecofamily5 = ecofamily5) +
  (Ecofamily = ecofamily) + 
  (Authority = autho) ~
    factor(year) * (Mean + SD + (Number = N)),
  output = "tinytable",
            data = cbs)

# t2_cbs

ls_ctrl <- c(
  "age" = "Age",
  "female" = "Gender",
  "party" = "Party",
  "edu" = "Education",
  "interstpol" = "Poltical Interst",
  "frepol" = "Poltical Frequency",
  "socialLevel" = "SocialLevel",
  "hukouRural" = "Urban",
  "marriage" = "Marriage",
  `as.factor(cohort)2` = "Cohort2",
  `as.factor(cohort)3` = "Cohort3",
  `as.factor(cohort)4` = "Cohort4",
  `as.factor(cohort)5` = "Cohort5",
  `as.factor(cohort)6` = "Cohort6",
  `as.factor(cohort)7` = "Cohort7",
  `as.factor(cohort)8` = "Cohort8",
  `as.factor(cohort)9` = "Cohort9",
  `as.factor(cohort)10` = "Cohort10",
  year2002 = "2002",
  year2011 = "2011",
  year2014 = "2014",
  year2008 = "2008",
  year2019 = "2019"
)

# write.csv(cbs,file = "../data/cbs.csv")
```


## factor analysis
```{r}
fct_cbs <- cbs %>%
  select(.,autho1,autho2,autho4,autho9)

psych::KMO(fct_cbs)
bartlett.test(fct_cbs)
pc_cbs <- principal(fct_cbs,1,rotate = "varimax")
pc_cbs
fa.diagram(pc_cbs$loadings, digits = 3)

```

# Democracy concept

## RE Analysis

### cohort
```{r}
#| label: concept
## cohort
# glm_concept <- stan_glmer(as.factor(demscorer) ~ age + female + party + edu + interstpol + frepol + socialLevel + hukouRural + marriage  + (1|cohort) + (1|year),data = cbs,family = binomial)

lm_concept <- lmerTest::lmer(demscore ~ age + female + party + edu + interstpol + frepol + socialLevel + hukouRural + marriage  + (1|cohort) + (1|year),data = cbs,weights = weight)
lm_demlevel <- update(lm_concept,demlevel ~.)
lm_demsatisify <- update(lm_concept,demsatisify ~.)
lm_diffa2c <- update(lm_concept,demdiff ~.)

mlist_dem_cohort <- list(
  lm_demsatisify,
  lm_demlevel,
  lm_concept,
  lm_diffa2c
)
rdem <- msummary(mlist_dem_cohort,
         #output = "kableExtra",
         stars = TRUE,
         # coef_rename = ls_ctrl,
         # gof_omit = "F",
         coef_omit = "(Intercept)")


# Extract the random effect
u0_cohort_concept <- ranef(lm_concept, condVar = TRUE)
names(u0_cohort_concept$year) <- "est_concept"
names(u0_cohort_concept$cohort) <- "est_concept"

period_eff_cohort_concept <- data.frame(est_concept = u0_cohort_concept$year, 
                         se = sqrt(attr(u0_cohort_concept[[2]], "postVar")[1, ,]),
                         period = c(2011, 2014, 2019))

cohort_eff_cohort_concept <- data.frame(est_concept = u0_cohort_concept$cohort, 
                         se = sqrt(attr(u0_cohort_concept[[1]], "postVar")[1, ,]),
                         cohort = c("1905/1945", 
                                    "1946/1960", 
                                    "1961/1970",
                                    "1971/1980",
                                    "1981/2001"))
period_eff_cohort_concept$upper <- period_eff_cohort_concept$est_concept + 1.96*period_eff_cohort_concept$se
period_eff_cohort_concept$lower <- period_eff_cohort_concept$est_concept - 1.96*period_eff_cohort_concept$se
cohort_eff_cohort_concept$upper <- cohort_eff_cohort_concept$est_concept + 1.96*cohort_eff_cohort_concept$se
cohort_eff_cohort_concept$lower <- cohort_eff_cohort_concept$est_concept - 1.96*cohort_eff_cohort_concept$se



u0_cohort_demlevel <- ranef(lm_demlevel, condVar = TRUE)
names(u0_cohort_demlevel$year) <- "est_demlevel"
names(u0_cohort_demlevel$cohort) <- "est_demlevel"

period_eff_cohort_demlevel <- data.frame(est_demlevel = u0_cohort_demlevel$year, 
                         se = sqrt(attr(u0_cohort_demlevel[[2]], "postVar")[1, ,]),
                         period = c(2002,2008,2011, 2014, 2019))

cohort_eff_cohort_demlevel <- data.frame(est_demlevel = u0_cohort_demlevel$cohort, 
                         se = sqrt(attr(u0_cohort_demlevel[[1]], "postVar")[1, ,]),
                         cohort = c("1905/1945", 
                                    "1946/1960", 
                                    "1961/1970",
                                    "1971/1980",
                                    "1981/2001"))

period_eff_cohort_demlevel$upper <- period_eff_cohort_demlevel$est_demlevel + 1.96*period_eff_cohort_demlevel$se
period_eff_cohort_demlevel$lower <- period_eff_cohort_demlevel$est_demlevel - 1.96*period_eff_cohort_demlevel$se
cohort_eff_cohort_demlevel$upper <- cohort_eff_cohort_demlevel$est_demlevel + 1.96*cohort_eff_cohort_demlevel$se
cohort_eff_cohort_demlevel$lower <- cohort_eff_cohort_demlevel$est_demlevel - 1.96*cohort_eff_cohort_demlevel$se



u0_cohort_demsatisify <- ranef(lm_demsatisify, condVar = TRUE)
names(u0_cohort_demsatisify$year) <- "est_demsatisify"
names(u0_cohort_demsatisify$cohort) <- "est_demsatisify"

period_eff_cohort_demsatisify <- data.frame(est_demsatisify = u0_cohort_demsatisify$year, 
                         se = sqrt(attr(u0_cohort_demsatisify[[2]], "postVar")[1, ,]),
                         period = c(2002,2008,2011, 2014, 2019))

cohort_eff_cohort_demsatisify <- data.frame(est_demsatisify = u0_cohort_demsatisify$cohort, 
                         se = sqrt(attr(u0_cohort_demsatisify[[1]], "postVar")[1, ,]),
                         cohort = c("1905/1945", 
                                    "1946/1960", 
                                    "1961/1970",
                                    "1971/1980",
                                    "1981/2001"))

period_eff_cohort_demsatisify$upper <- period_eff_cohort_demsatisify$est_demsatisify + 1.96*period_eff_cohort_demsatisify$se
period_eff_cohort_demsatisify$lower <- period_eff_cohort_demsatisify$est_demsatisify - 1.96*period_eff_cohort_demsatisify$se
cohort_eff_cohort_demsatisify$upper <- cohort_eff_cohort_demsatisify$est_demsatisify + 1.96*cohort_eff_cohort_demsatisify$se
cohort_eff_cohort_demsatisify$lower <- cohort_eff_cohort_demsatisify$est_demsatisify - 1.96*cohort_eff_cohort_demsatisify$se



period_eff_cohort_concept$period <- as.factor(period_eff_cohort_concept$period)
period_eff_cohort_demsatisify$period <- as.factor(period_eff_cohort_demsatisify$period)
period_eff_cohort_demlevel$period <- as.factor(period_eff_cohort_demlevel$period)


plot_period_cohort_concept <- ggplot(period_eff_cohort_concept, aes(x = period, y = est_concept)) +
  geom_point() + 
  geom_errorbar(aes(ymin = lower, ymax = upper), width = .15) + 
  scale_y_continuous(limits = c(-.1,.1)) + 
  xlab("Year") + 
  ylab("The period effect of Concept")
# plot_period_cohort_concept

plot_period_cohort_demlevel <- ggplot(period_eff_cohort_demlevel, aes(x = period, y = est_demlevel)) +
  geom_point() + 
  geom_errorbar(aes(ymin = lower, ymax = upper), width = .15) + 
  scale_y_continuous(limits = c(-1,1)) +
  xlab("Year") + 
  ylab("The period effect of Demlevel")
# plot_period_cohort_demlevel

plot_period_cohort_demsatisify <- ggplot(period_eff_cohort_demsatisify, aes(x = period, y = est_demsatisify)) +
  geom_point() + 
  geom_errorbar(aes(ymin = lower, ymax = upper), width = .15) + 
  scale_y_continuous(limits = c(-1,1)) +
  xlab("Year") + 
  ylab("The period effect of Demsatisify") 
# plot_period_cohort_demsatisify



plot_cohort_cohort_concpet <- ggplot(cohort_eff_cohort_concept, aes(x = cohort, y = est_concept)) +
  geom_point() + 
  geom_errorbar(aes(ymin = lower, ymax = upper), width = .2) + 
  scale_y_continuous(limits = c(-.1, .1)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
  xlab("Cohort") + 
  ylab("The cohort effect of Concept")
# plot_cohort_cohort_concpet

plot_cohort_cohort_demlevel <- ggplot(cohort_eff_cohort_demlevel, aes(x = cohort, y = est_demlevel)) +
  geom_point() + 
  geom_errorbar(aes(ymin = lower, ymax = upper), width = .2) + 
  scale_y_continuous(limits = c(-1,1)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
  xlab("Cohort") + 
  ylab("The cohort effect of Demlevel")
# plot_cohort_cohort_demlevel

plot_cohort_cohort_demsatisify <- ggplot(cohort_eff_cohort_demsatisify, aes(x = cohort, y = est_demsatisify)) +
  geom_point() + 
  geom_errorbar(aes(ymin = lower, ymax = upper), width = .2) + 
  scale_y_continuous(limits = c(-1,1)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
  xlab("Cohort") + 
  ylab("The cohort effect of Demsatisify")
# plot_cohort_cohort_demsatisify

plot_cohort_cohort_effect <- ggarrange(
  plot_cohort_cohort_demlevel,
  plot_cohort_cohort_demsatisify, 
  plot_cohort_cohort_concpet,
  ncol = 3, nrow = 1) 

plot_period_cohort_effect <- ggarrange(
  plot_period_cohort_demlevel,
  plot_period_cohort_demsatisify, 
  plot_period_cohort_concept,
  ncol = 3, nrow = 1) 

plot_cohort_cohort_effect
plot_period_cohort_effect 
# ggsave(plot_cohort_cohort_effect,file = "../fig/re_cohort_concept.pdf")
# ggsave(plot_period_cohort_effect,file = "../fig/re_period_concept.pdf")
```

::: {.callout-imp}
1. 民主观念有世代差异:
 - 后三个时期与0无异。
1. 民主水平有世代差异
1. 时期也有差异：
 - 民主水平：2008与0无异; 2011/2014<0; 2019>0
 - 民主满意度:都与0无差异
 
:::


### cohort10
```{r}
#| label: cohort_effect_concpt10
lm_concept10 <- lmerTest::lmer(demscore ~ age + female + party + edu + interstpol + frepol + socialLevel + hukouRural + marriage  + (1|cohort10) + (1|year),data = cbs,weights = weight)
lm_demlevel10 <- update(lm_concept10,demlevel ~.)
lm_demsatisify10 <- update(lm_concept10,demsatisify ~.)

# Extract the random effect
u0_cohort10_concept <- ranef(lm_concept10, condVar = TRUE)
names(u0_cohort10_concept$year) <- "est_concept"
names(u0_cohort10_concept$cohort10) <- "est_concept"

period_eff_cohort10_concept <- data.frame(est_concept = u0_cohort10_concept$year, 
                         se = sqrt(attr(u0_cohort10_concept[[2]], "postVar")[1, ,]),
                         period = c(2011, 2014, 2019))

cohort_eff_cohort10_concept <- data.frame(est_concept = u0_cohort10_concept$cohort10, 
                         se = sqrt(attr(u0_cohort10_concept[[1]], "postVar")[1, ,]),
                         cohort10 = c("1905/1948",
                                      "1959/1958",
                                      "1959/1968", 
                                      "1969/1978",
                                      "1979/1988",
                                      "1981/2001"))
period_eff_cohort10_concept$upper <- period_eff_cohort10_concept$est_concept + 1.96*period_eff_cohort10_concept$se
period_eff_cohort10_concept$lower <- period_eff_cohort10_concept$est_concept - 1.96*period_eff_cohort10_concept$se
cohort_eff_cohort10_concept$upper <- cohort_eff_cohort10_concept$est_concept + 1.96*cohort_eff_cohort10_concept$se
cohort_eff_cohort10_concept$lower <- cohort_eff_cohort10_concept$est_concept - 1.96*cohort_eff_cohort10_concept$se



u0_cohort10_demlevel <- ranef(lm_demlevel10, condVar = TRUE)
names(u0_cohort10_demlevel$year) <- "est_demlevel"
names(u0_cohort10_demlevel$cohort10) <- "est_demlevel"

period_eff_cohort10_demlevel <- data.frame(est_demlevel = u0_cohort10_demlevel$year, 
                         se = sqrt(attr(u0_cohort10_demlevel[[2]], "postVar")[1, ,]),
                         period = c(2002,2008,2011, 2014, 2019))

cohort_eff_cohort10_demlevel <- data.frame(est_demlevel = u0_cohort10_demlevel$cohort10, 
                         se = sqrt(attr(u0_cohort10_demlevel[[1]], "postVar")[1, ,]),
                         cohort10 = c("1905/1948",
                                      "1949/1958",
                                      "1959/1968", 
                                      "1969/1978",
                                      "1979/1988",
                                      "1981/2001"))

period_eff_cohort10_demlevel$upper <- period_eff_cohort10_demlevel$est_demlevel + 1.96*period_eff_cohort10_demlevel$se
period_eff_cohort10_demlevel$lower <- period_eff_cohort10_demlevel$est_demlevel - 1.96*period_eff_cohort10_demlevel$se
cohort_eff_cohort10_demlevel$upper <- cohort_eff_cohort10_demlevel$est_demlevel + 1.96*cohort_eff_cohort10_demlevel$se
cohort_eff_cohort10_demlevel$lower <- cohort_eff_cohort10_demlevel$est_demlevel - 1.96*cohort_eff_cohort10_demlevel$se


u0_cohort10_demsatisify <- ranef(lm_demsatisify10, condVar = TRUE)
names(u0_cohort10_demsatisify$year) <- "est_demsatisify"
names(u0_cohort10_demsatisify$cohort10) <- "est_demsatisify"

period_eff_cohort10_demsatisify <- data.frame(est_demsatisify = u0_cohort10_demsatisify$year, 
                         se = sqrt(attr(u0_cohort10_demsatisify[[2]], "postVar")[1, ,]),
                         period = c(2002,2008,2011, 2014, 2019))

cohort_eff_cohort10_demsatisify <- data.frame(est_demsatisify = u0_cohort10_demsatisify$cohort10, 
                         se = sqrt(attr(u0_cohort10_demsatisify[[1]], "postVar")[1, ,]),
                         cohort10 = c("1905/1948",
                                      "1949/1958",
                                      "1959/1968", 
                                      "1969/1978",
                                      "1979/1988",
                                      "1981/2001"))

period_eff_cohort10_demsatisify$upper <- period_eff_cohort10_demsatisify$est_demsatisify + 1.96*period_eff_cohort10_demsatisify$se
period_eff_cohort10_demsatisify$lower <- period_eff_cohort10_demsatisify$est_demsatisify - 1.96*period_eff_cohort10_demsatisify$se
cohort_eff_cohort10_demsatisify$upper <- cohort_eff_cohort10_demsatisify$est_demsatisify + 1.96*cohort_eff_cohort10_demsatisify$se
cohort_eff_cohort10_demsatisify$lower <- cohort_eff_cohort10_demsatisify$est_demsatisify - 1.96*cohort_eff_cohort10_demsatisify$se



period_eff_cohort10_concept$period <- as.factor(period_eff_cohort10_concept$period)
period_eff_cohort10_demsatisify$period <- as.factor(period_eff_cohort10_demsatisify$period)
period_eff_cohort10_demlevel$period <- as.factor(period_eff_cohort10_demlevel$period)


plot_period_cohort10_concept <- ggplot(period_eff_cohort10_concept, aes(x = period, y = est_concept)) +
  geom_point() + 
  geom_errorbar(aes(ymin = lower, ymax = upper), width = .15) + 
  scale_y_continuous(limits = c(-.1,.1)) + 
  xlab("Year") + 
  ylab("The period effect of Concept")
# plot_period_cohort10_concept

plot_period_cohort10_demlevel <- ggplot(period_eff_cohort10_demlevel, aes(x = period, y = est_demlevel)) +
  geom_point() + 
  geom_errorbar(aes(ymin = lower, ymax = upper), width = .15) + 
  scale_y_continuous(limits = c(-1,1)) +
  xlab("Year") + 
  ylab("The period effect of Demlevel")
# plot_period_cohort10_demlevel

plot_period_cohort10_demsatisify <- ggplot(period_eff_cohort10_demsatisify, aes(x = period, y = est_demsatisify)) +
  geom_point() + 
  geom_errorbar(aes(ymin = lower, ymax = upper), width = .15) + 
  scale_y_continuous(limits = c(-1,1)) +
  xlab("Year") + 
  ylab("The period effect of Demsatisify") 
# plot_period_cohort10_demsatisify



plot_cohort_cohort10_concpet <- ggplot(cohort_eff_cohort10_concept, aes(x = cohort10, y = est_concept)) +
  geom_point() + 
  geom_errorbar(aes(ymin = lower, ymax = upper), width = .2) + 
  scale_y_continuous(limits = c(-.1, .1)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
  xlab("cohort10") + 
  ylab("The cohort10 effect of Concept")
# plot_cohort10_cohort10_concpet

plot_cohort_cohort10_demlevel <- ggplot(cohort_eff_cohort10_demlevel, aes(x = cohort10, y = est_demlevel)) +
  geom_point() + 
  geom_errorbar(aes(ymin = lower, ymax = upper), width = .2) + 
  scale_y_continuous(limits = c(-1,1)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
  xlab("cohort10") + 
  ylab("The cohort10 effect of Demlevel")
# plot_cohort10_cohort10_demlevel

plot_cohort_cohort10_demsatisify <- ggplot(cohort_eff_cohort10_demsatisify, aes(x = cohort10, y = est_demsatisify)) +
  geom_point() + 
  geom_errorbar(aes(ymin = lower, ymax = upper), width = .2) + 
  scale_y_continuous(limits = c(-1,1)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
  xlab("cohort10") + 
  ylab("The cohort10 effect of Demsatisify")
# plot_cohort10_cohort10_demsatisify

plot_cohort_cohort10_effect <- ggarrange(
  plot_cohort_cohort10_demlevel,
  plot_cohort_cohort10_demsatisify, 
  plot_cohort_cohort10_concpet,
  ncol = 3, nrow = 1) 

plot_period_cohort10_effect <- ggarrange(
  plot_period_cohort10_demlevel,
  plot_period_cohort10_demsatisify, 
  plot_period_cohort10_concept,
  ncol = 3, nrow = 1) 

plot_cohort_cohort10_effect
plot_period_cohort10_effect 
# ggsave(plot_period_cohrot_concept,file = "../fig/period_cohort10_concept.pdf")
# ggsave(plot_cohort10_cohort10_concpet,file = "../fig/cohort10_cohort10_concept.pdf")
```

### cohort5
```{r}
#| label: cohort_effect_concpt5
lm_concept5 <- lmerTest::lmer(demscore ~ age + female + party + edu + interstpol + frepol + socialLevel + hukouRural + marriage  + (1|cohort5) + (1|year),data = cbs,weights = weight)
lm_demlevel5 <- update(lm_concept5,demlevel ~.)
lm_demsatisify5 <- update(lm_concept5,demsatisify ~.)

# Extract the random effect
u0_cohort5_concept <- ranef(lm_concept5, condVar = TRUE)
names(u0_cohort5_concept$year) <- "est_concept"
names(u0_cohort5_concept$cohort5) <- "est_concept"

period_eff_cohort5_concept <- data.frame(est_concept = u0_cohort5_concept$year, 
                         se = sqrt(attr(u0_cohort5_concept[[2]], "postVar")[1, ,]),
                         period = c(2011, 2014, 2019))

cohort_eff_cohort5_concept <- data.frame(est_concept = u0_cohort5_concept$cohort5, 
                         se = sqrt(attr(u0_cohort5_concept[[1]], "postVar")[1, ,]),
                         cohort5 = c("1905/1948",
                                     "1949/1954",
                                     "1955/1959",
                                     "1960/1964",
                                     "1965/1969",
                                     "1970/1974",
                                     "1975/1979",
                                     "1980/1984",
                                     "1990/1989",
                                     "1990/1994",
                                     "1995/2001"))
period_eff_cohort5_concept$upper <- period_eff_cohort5_concept$est_concept + 1.96*period_eff_cohort5_concept$se
period_eff_cohort5_concept$lower <- period_eff_cohort5_concept$est_concept - 1.96*period_eff_cohort5_concept$se
cohort_eff_cohort5_concept$upper <- cohort_eff_cohort5_concept$est_concept + 1.96*cohort_eff_cohort5_concept$se
cohort_eff_cohort5_concept$lower <- cohort_eff_cohort5_concept$est_concept - 1.96*cohort_eff_cohort5_concept$se



u0_cohort5_demlevel <- ranef(lm_demlevel5, condVar = TRUE)
names(u0_cohort5_demlevel$year) <- "est_demlevel"
names(u0_cohort5_demlevel$cohort5) <- "est_demlevel"

period_eff_cohort5_demlevel <- data.frame(est_demlevel = u0_cohort5_demlevel$year, 
                         se = sqrt(attr(u0_cohort5_demlevel[[2]], "postVar")[1, ,]),
                         period = c(2002,2008,2011, 2014, 2019))

cohort_eff_cohort5_demlevel <- data.frame(est_demlevel = u0_cohort5_demlevel$cohort5, 
                         se = sqrt(attr(u0_cohort5_demlevel[[1]], "postVar")[1, ,]),
                         cohort5 = c("1905/1948",
                                     "1949/1954",
                                     "1955/1959",
                                     "1960/1964",
                                     "1965/1969",
                                     "1970/1974",
                                     "1975/1979",
                                     "1980/1984",
                                     "1990/1989",
                                     "1990/1994",
                                     "1995/2001"))

period_eff_cohort5_demlevel$upper <- period_eff_cohort5_demlevel$est_demlevel + 1.96*period_eff_cohort5_demlevel$se
period_eff_cohort5_demlevel$lower <- period_eff_cohort5_demlevel$est_demlevel - 1.96*period_eff_cohort5_demlevel$se
cohort_eff_cohort5_demlevel$upper <- cohort_eff_cohort5_demlevel$est_demlevel + 1.96*cohort_eff_cohort5_demlevel$se
cohort_eff_cohort5_demlevel$lower <- cohort_eff_cohort5_demlevel$est_demlevel - 1.96*cohort_eff_cohort5_demlevel$se


u0_cohort5_demsatisify <- ranef(lm_demsatisify5, condVar = TRUE)
names(u0_cohort5_demsatisify$year) <- "est_demsatisify"
names(u0_cohort5_demsatisify$cohort5) <- "est_demsatisify"

period_eff_cohort5_demsatisify <- data.frame(est_demsatisify = u0_cohort5_demsatisify$year, 
                         se = sqrt(attr(u0_cohort5_demsatisify[[2]], "postVar")[1, ,]),
                         period = c(2002,2008,2011, 2014, 2019))

cohort_eff_cohort5_demsatisify <- data.frame(est_demsatisify = u0_cohort5_demsatisify$cohort5, 
                         se = sqrt(attr(u0_cohort5_demsatisify[[1]], "postVar")[1, ,]),
                         cohort5 = c("1905/1948",
                                     "1949/1954",
                                     "1955/1959",
                                     "1960/1964",
                                     "1965/1969",
                                     "1970/1974",
                                     "1975/1979",
                                     "1980/1984",
                                     "1990/1989",
                                     "1990/1994",
                                     "1995/2001"))

period_eff_cohort5_demsatisify$upper <- period_eff_cohort5_demsatisify$est_demsatisify + 1.96*period_eff_cohort5_demsatisify$se
period_eff_cohort5_demsatisify$lower <- period_eff_cohort5_demsatisify$est_demsatisify - 1.96*period_eff_cohort5_demsatisify$se
cohort_eff_cohort5_demsatisify$upper <- cohort_eff_cohort5_demsatisify$est_demsatisify + 1.96*cohort_eff_cohort5_demsatisify$se
cohort_eff_cohort5_demsatisify$lower <- cohort_eff_cohort5_demsatisify$est_demsatisify - 1.96*cohort_eff_cohort5_demsatisify$se



period_eff_cohort5_concept$period <- as.factor(period_eff_cohort5_concept$period)
period_eff_cohort5_demsatisify$period <- as.factor(period_eff_cohort5_demsatisify$period)
period_eff_cohort5_demlevel$period <- as.factor(period_eff_cohort5_demlevel$period)


plot_period_cohort5_concept <- ggplot(period_eff_cohort5_concept, aes(x = period, y = est_concept)) +
  geom_point() + 
  geom_errorbar(aes(ymin = lower, ymax = upper), width = .15) + 
  scale_y_continuous(limits = c(-.1,.1)) + 
  xlab("Year") + 
  ylab("The period effect of Concept")
# plot_period_cohort5_concept

plot_period_cohort5_demlevel <- ggplot(period_eff_cohort5_demlevel, aes(x = period, y = est_demlevel)) +
  geom_point() + 
  geom_errorbar(aes(ymin = lower, ymax = upper), width = .15) + 
  scale_y_continuous(limits = c(-1,1)) +
  xlab("Year") + 
  ylab("The period effect of Demlevel")
# plot_period_cohort5_demlevel

plot_period_cohort5_demsatisify <- ggplot(period_eff_cohort5_demsatisify, aes(x = period, y = est_demsatisify)) +
  geom_point() + 
  geom_errorbar(aes(ymin = lower, ymax = upper), width = .15) + 
  scale_y_continuous(limits = c(-1,1)) +
  xlab("Year") + 
  ylab("The period effect of Demsatisify") 
# plot_period_cohort5_demsatisify



plot_cohort_cohort5_concpet <- ggplot(cohort_eff_cohort5_concept, aes(x = cohort5, y = est_concept)) +
  geom_point() + 
  geom_errorbar(aes(ymin = lower, ymax = upper), width = .2) + 
  scale_y_continuous(limits = c(-.1, .1)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  xlab("cohort5") + 
  ylab("The cohort5 effect of Concept")
# plot_cohort_cohort5_concpet

plot_cohort_cohort5_demlevel <- ggplot(cohort_eff_cohort5_demlevel, aes(x = cohort5, y = est_demlevel)) +
  geom_point() + 
  geom_errorbar(aes(ymin = lower, ymax = upper), width = .2) + 
  scale_y_continuous(limits = c(-1,1)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  xlab("cohort5") + 
  ylab("The cohort5 effect of Demlevel")
# plot_cohort_cohort5_demlevel

plot_cohort_cohort5_demsatisify <- ggplot(cohort_eff_cohort5_demsatisify, aes(x = cohort5, y = est_demsatisify)) +
  geom_point() + 
  geom_errorbar(aes(ymin = lower, ymax = upper), width = .2) + 
  scale_y_continuous(limits = c(-1,1)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  xlab("cohort5") + 
  ylab("The cohort5 effect of Demsatisify")
# plot_cohort_cohort5_demsatisify

plot_cohort_cohort5_effect <- ggarrange(
  plot_cohort_cohort5_demlevel,
  plot_cohort_cohort5_demsatisify, 
  plot_cohort_cohort5_concpet,
  ncol = 3, nrow = 1) 

plot_period_cohort5_effect <- ggarrange(
  plot_period_cohort5_demlevel,
  plot_period_cohort5_demsatisify, 
  plot_period_cohort5_concept,
  ncol = 3, nrow = 1) 

plot_cohort_cohort5_effect
plot_period_cohort5_effect 
# ggsave(plot_period_cohrot_concept,file = "../fig/period_cohort5_concept.pdf")
# ggsave(plot_cohort5_cohort5_concpet,file = "../fig/cohort5_cohort5_concept.pdf")
```



## FE Analysis
### cohort
```{r}
## cohort
cbs <- read.csv("../data/cbs.csv")
gfm_concept <- glm(as.factor(demscorer) ~ age + female + party + edu + interstpol + frepol + socialLevel + hukouRural + marriage  + as.factor(cohort) + year,data = cbs,family = binomial)
fm_concept <- lm(demscore ~ age + female + party + edu + interstpol + frepol + socialLevel + hukouRural + marriage  + as.factor(cohort) + year,data = cbs,weights = weight)
fm_demlevel <- update(fm_concept,demlevel ~.)
fm_demsatisify <- update(fm_concept,demsatisify ~.)
fm_diffa2c <- update(fm_concept, demdiff ~ .)


flist <- list(
  Demconcep = fm_concept,
  Demlevel = fm_demlevel,
  Demsatisify = fm_demsatisify,
  Diffa2c = fm_diffa2c
)
t2_fdem <- msummary(flist,
         stars = TRUE,
         coef_rename = ls_ctrl,
         output = "tinytable")

t2_fdem
```

#### plot_cohort
```{r}
fm1_concept <- broom::tidy(fm_concept) %>%
  filter(grepl("^(as.factor)",term)) %>%
  rename(est = estimate,
         se = std.error,
         cohort = term) %>%
  mutate(upper = est + 1.96*se,
         lower = est - 1.96*se)
fm1_concept$cohort <- gsub("^(as.factor)", "",fm1_concept$cohort)

fm1_demlevel <- broom::tidy(fm_demlevel) %>%
  filter(grepl("^(as.factor)",term)) %>%
  rename(est = estimate,
         se = std.error,
         cohort = term) %>%
  mutate(upper = est + 1.96*se,
         lower = est - 1.96*se)
fm1_demlevel$cohort <- gsub("^(as.factor)", "",fm1_demlevel$cohort)

fm1_demsatisify <- broom::tidy(fm_demsatisify) %>%
  filter(grepl("^(as.factor)",term)) %>%
  rename(est = estimate,
         se = std.error,
         cohort = term) %>%
  mutate(upper = est + 1.96*se,
         lower = est - 1.96*se)
fm1_demsatisify$cohort <- gsub("^(as.factor)", "",fm1_demsatisify$cohort)

p1_concept <- ggplot(fm1_concept, aes(x = cohort, y = est)) +
  geom_point() + 
  geom_errorbar(aes(ymin = lower, ymax = upper), width = .15) + 
  geom_hline(
    yintercept = 0,
    linetype = 2,
    colour = "grey60"
  ) +
  scale_y_continuous(limits = c(-1.5,1)) +
  xlab("Cohort") + 
  ylab("The cohort effect of Concept")

p1_demlevel <- ggplot(fm1_demlevel, aes(x = cohort, y = est)) +
  geom_point() + 
  geom_errorbar(aes(ymin = lower, ymax = upper), width = .15) + 
  geom_hline(
    yintercept = 0,
    linetype = 2,
    colour = "grey60"
  ) +
  scale_y_continuous(limits = c(-1.5,1)) +
  xlab("Cohort") + 
  ylab("The cohort effect of Demlevel")


p1_demsatisify <- ggplot(fm1_demsatisify, aes(x = cohort, y = est)) +
  geom_point() + 
  geom_errorbar(aes(ymin = lower, ymax = upper), width = .15) + 
  geom_hline(
    yintercept = 0,
    linetype = 2,
    colour = "grey60"
  ) + 
  scale_y_continuous(limits = c(-1.5,1)) +
  xlab("Cohort") + 
  ylab("The cohort effect of Demsatisify")

p1_dem <- ggarrange(
  Demlevel = p1_demlevel, 
  Demsatisify = p1_demsatisify,
  Concept = p1_concept,
  ncol = 3, nrow = 1) 

p1_dem
ggsave(p1_dem,file = "../fig/fe_cohort_dem.pdf")
```


### cohort5
```{r}
## cohort
gfm_concept5 <- glm(as.factor(demscorer) ~ age + female + party + edu + interstpol + frepol + socialLevel + hukouRural + marriage  + as.factor(cohort5) + year,data = cbs,family = binomial)
fm_concept5 <- lm(demscore ~ age + female + party + edu + interstpol + frepol + socialLevel + hukouRural + marriage  + as.factor(cohort5) + year,data = cbs,weights = weight)
fm_demlevel5 <- update(fm_concept5,demlevel ~.)
fm_demsatisify5 <- update(fm_concept5,demsatisify ~.)


flist5 <- list(
  Demscore5 = fm_concept5,
  Demscore5 = gfm_concept5,
  Demlevel5 = fm_demlevel5,
  Demsatisify5= fm_demsatisify5
)
t2_fdem5 <- msummary(flist5,
         stars = TRUE,
         coef_rename = ls_ctrl,
         output = "tinytable")

t2_fdem5
```

### cohort10
```{r}
#| label: FE for dem

## cohort
gfm_concept10 <- update(gfm_concept,.~. -as.factor(cohort) + as.factor(cohort10))
fm_concept10 <- update(fm_concept,.~. -as.factor(cohort) + as.factor(cohort10))
fm_demlevel10 <- update(fm_concept,demlevel ~. -as.factor(cohort) + as.factor(cohort10))
fm_demsatisify10 <- update(fm_concept10,demsatisify ~. -as.factor(cohort) + as.factor(cohort10))


flist10 <- list(
  Demscore10 = fm_concept10,
  Demscore10 = gfm_concept10,
  Demlevel10 = fm_demlevel10,
  Demsatisify10= fm_demsatisify10
)
t2_fdem10 <- msummary(flist10,
         stars = TRUE,
         coef_rename = ls_ctrl,
         output = "tinytable")

t2_fdem10
```




# Leader
## RE_Leader
### cohort
```{r}
#| label: leader
lm_leader_cohort <- lmerTest::lmer(leader ~ age + female + party + edu + interstpol + frepol + socialLevel + marriage  + (1|cohort) + (1|year),
                            data = cbs,
                            weights = weight
                            )

u0_leader <- ranef(lm_leader_cohort, condVar = TRUE)
names(u0_leader$year) <- "est_leader"
names(u0_leader$cohort) <- "est_leader"

#Extract the standard error
period_leader <- data.frame(est_leader = u0_leader$year, 
                         se = sqrt(attr(u0_leader[[2]], "postVar")[1, ,]),
                         period = c(2002,2008,2011, 2014, 2019))

cohort_leader <- data.frame(est_leader = u0_leader$cohort, 
                         se = sqrt(attr(u0_leader[[1]], "postVar")[1, ,]),
                         cohort = c("1905/1945", 
                                    "1946/1960", 
                                    "1961/1970",
                                    "1971/1980",
                                    "1981/2001"))

period_leader$upper <- period_leader$est_leader + 1.96*period_leader$se
period_leader$lower <- period_leader$est_leader - 1.96*period_leader$se
cohort_leader$upper <- cohort_leader$est_leader + 1.96*cohort_leader$se
cohort_leader$lower <- cohort_leader$est_leader - 1.96*cohort_leader$se

period_leader$period <- as.factor(period_leader$period)
plot_period_leader <- ggplot(period_leader, aes(x = period, y = est_leader)) +
  geom_point() + 
  geom_errorbar(aes(ymin = lower, ymax = upper), width = .2) + 
  geom_hline(
    yintercept = 0,
    linetype = 2,
    colour = "grey60"
  ) +
  xlab("Period") + 
  ylab("The period effect of Leader")
plot_period_leader

plot_cohort_leader <- ggplot(cohort_leader, aes(x = cohort, y = est_leader)) +
  geom_point() + 
  geom_errorbar(aes(ymin = lower, ymax = upper), width = .2) +
  scale_y_continuous(limits = c(-1,1)) +
  geom_hline(
    yintercept = 0,
    linetype = 2,
    colour = "grey60"
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  xlab("Cohort") + 
  ylab("The cohort effect of Leader")
plot_cohort_leader

pr_leader <- ggarrange(
  plot_cohort_leader,
  plot_period_leader
)
pr_leader
# ggsave(pr_leader,file = "../fig/re_leader.pdf")
```

#### cohort5/10
```{r}
lm_leader_cohort10 <- update(lm_leader_cohort,. ~ . -(1|cohort) + (1|cohort10))

lm_leader_cohort5 <- update(lm_leader_cohort,. ~ . -(1|cohort) + (1|cohort5))

u0_leader5 <- ranef(lm_leader_cohort5, condVar = TRUE)
names(u0_leader5$year) <- "est_leader"
names(u0_leader5$cohort5) <- "est_leader"

#Extract the standard error
period_leader5 <- data.frame(est_leader = u0_leader5$year, 
                         se = sqrt(attr(u0_leader5[[2]], "postVar")[1, ,]),
                         period = c(2002,2008,2011, 2014, 2019))

cohort_leader5 <- data.frame(est_leader = u0_leader5$cohort5, 
                         se = sqrt(attr(u0_leader5[[1]], "postVar")[1, ,]),
                         cohort = c("1905/1948", 
                                    "1949/1954", 
                                    "1955/1959",
                                    "1960/1964",
                                    "1965/1969",
                                    "1970/1974",
                                    "1975/1979",
                                    "1980/1984",
                                    "1985/1989",
                                    "1990/1994",
                                    "1995/2000"))

period_leader5$upper <- period_leader5$est_leader + 1.96*period_leader5$se
period_leader5$lower <- period_leader5$est_leader - 1.96*period_leader5$se
cohort_leader5$upper <- cohort_leader5$est_leader + 1.96*cohort_leader5$se
cohort_leader5$lower <- cohort_leader5$est_leader - 1.96*cohort_leader5$se

period_leader5$period <- as.factor(period_leader5$period)
plot_period_leader5 <- ggplot(period_leader5, aes(x = period, y = est_leader)) +
  geom_point() + 
  geom_errorbar(aes(ymin = lower, ymax = upper), width = .2) + 
  xlab("Year") + 
  ylab("The period effect of Leader")
plot_period_leader

plot_cohort_leader5 <- ggplot(cohort_leader5, aes(x = cohort, y = est_leader)) +
  geom_point() + 
  geom_errorbar(aes(ymin = lower, ymax = upper), width = .2) +
  scale_y_continuous(limits = c(-.5,.5)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  xlab("Cohort") + 
  ylab("Conditional log odds of the cohort effect")
plot_cohort_leader5


u0_leader10 <- ranef(lm_leader_cohort10, condVar = TRUE)
names(u0_leader10$year) <- "est_leader"
names(u0_leader10$cohort10) <- "est_leader"

#Extract the standard error
period_leader10 <- data.frame(est_leader = u0_leader10$year, 
                         se = sqrt(attr(u0_leader10[[2]], "postVar")[1, ,]),
                         period = c(2002,2008,2011, 2014, 2019))

cohort_leader10 <- data.frame(est_leader = u0_leader10$cohort10, 
                         se = sqrt(attr(u0_leader10[[1]], "postVar")[1, ,]),
                         cohort = c("1905/1948", 
                                    "1949/1958", 
                                    "1959/1968",
                                    "1969/1978",
                                    "1979/1988",
                                    "1989/2000"))

period_leader10$upper <- period_leader10$est_leader + 1.96*period_leader10$se
period_leader10$lower <- period_leader10$est_leader - 1.96*period_leader10$se
cohort_leader10$upper <- cohort_leader10$est_leader + 1.96*cohort_leader10$se
cohort_leader10$lower <- cohort_leader10$est_leader - 1.96*cohort_leader10$se

period_leader10$period <- as.factor(period_leader10$period)
plot_period_leader10 <- ggplot(period_leader10, aes(x = period, y = est_leader)) +
  geom_point() + 
  geom_errorbar(aes(ymin = lower, ymax = upper), width = .2) + 
  xlab("Year") + 
  ylab("The period effect of Leader")
plot_period_leader10

plot_cohort_leader10 <- ggplot(cohort_leader10, aes(x = cohort, y = est_leader)) +
  geom_point() + 
  geom_errorbar(aes(ymin = lower, ymax = upper), width = .2) +
  scale_y_continuous(limits = c(-.5,.5)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  xlab("Cohort") + 
  ylab("Conditional log odds of the cohort effect")
plot_cohort_leader10


# ggsave(plot_period,file = "../fig/effect_leader_period.pdf")
# ggsave(plot_cohort,file = "../fig/effect_leader_cohort.pdf")
```

## FE_Leader
### Regression
```{r}
fm_leader <- update(fm_concept, leader ~ .)
fm_leader5 <- update(fm_leader,. ~ . -as.factor(cohort) + as.factor(cohort5))
fm_leader10 <- update(fm_leader,. ~ . -as.factor(cohort) + as.factor(cohort10))

flist_leader <- list(
  Leader = fm_leader,
  Leader5 = fm_leader5,
  Leader10 = fm_leader10
  
)
t3_fleader <- msummary(flist_leader,
         stars = TRUE,
         coef_rename = ls_ctrl,
         output = "tinytable")
t3_fleader
```

### plot_leader

```{r}
df_cohort_leader <- broom::tidy(fm_leader) %>%
  filter(grepl("^(as.factor)",term)) %>%
  rename(est = estimate,
         se = std.error,
         cohort = term) %>%
  mutate(upper = est + 1.96*se,
         lower = est - 1.96*se)
df_cohort_leader$cohort <- gsub("^(as.factor)", "",df_cohort_leader$cohort)

pf_cohort_leader <- ggplot(df_cohort_leader, aes(x = cohort, y = est)) +
  geom_point() + 
  geom_errorbar(aes(ymin = lower, ymax = upper), width = .15) + 
  geom_hline(
    yintercept = 0,
    colour = "grey60",
    linetype = 2
  ) +
  scale_y_continuous(limits = c(-1,1)) +
  xlab("Cohort") + 
  ylab("The cohort effect of Leader")

pf_cohort_leader

df_period_leader <- broom::tidy(fm_leader) %>%
  filter(grepl("^year",term)) %>%
  rename(est = estimate,
         se = std.error,
         Period = term) %>%
  mutate(upper = est + 1.96*se,
         lower = est - 1.96*se)
df_period_leader$Period <- gsub("^year", "",df_period_leader$Period)

pf_period_leader <- ggplot(df_period_leader, aes(x = Period, y = est)) +
  geom_point() + 
  geom_errorbar(aes(ymin = lower, ymax = upper), width = .15) + 
  geom_hline(
    yintercept = 0,
    colour = "grey60",
    linetype = 2
  ) +
  scale_y_continuous(limits = c(-1,1)) +
  xlab("Period") + 
  ylab("The Period effect of Leader")


pf_leader <- ggarrange(
  pf_cohort_leader, 
  pf_period_leader) 
pf_leader


rf_cohort_leader <- ggarrange(
  pf_cohort_leader,
  plot_cohort_leader
)

rf_period_leader <- ggarrange(
  pf_period_leader,
  plot_period_leader
)
rf_period_leader
# ggsave(pf_leader,file = "../fig/pf_leader.pdf")
```



# Authority Orientations
## Cohort_effect
```{r}
#| label: authority
fm_autho <- update(fm_concept, autho ~ .)
lm_autho <- update(lm_concept, autho ~ .)

fm1_cohort_autho <- broom::tidy(fm_autho) %>%
  filter(grepl("^as.",term)) %>%
  rename(
    est = estimate,
    se = std.error,
    cohort = term
  ) %>%
  mutate(
    upper = est + 1.96 * se,
    lower = est - 1.96 * se
  )
fm1_cohort_autho$cohort <- gsub("^(as.factor)", "",fm1_cohort_autho$cohort)

pf_cohort_autho <- ggplot(fm1_cohort_autho, aes(x = cohort, y = est)) +
  geom_point() + 
  geom_errorbar(aes(ymin = lower, ymax = upper), width = .15) + 
  scale_y_continuous(limits = c(-.8,.8)) +
  geom_hline(
    yintercept = 0,
    colour = "grey60",
    linetype = 2) +
  xlab("Cohort") + 
  ylab("The cohort effect of Authority")
pf_cohort_autho


### plot_RE
u0_autho <- ranef(lm_autho, condVar = TRUE)
names(u0_autho$year) <- "est_autho"
names(u0_autho$cohort) <- "est_autho"

#Extract the standard error
period_eff_autho <- data.frame(est_autho = u0_autho$year, 
                         se = sqrt(attr(u0_autho[[2]], "postVar")[1, ,]),
                         period = c(2002,2008,2011,2014,2018))
cohort_eff_autho <- data.frame(est = u0_autho$cohort, 
                         se = sqrt(attr(u0_autho[[1]], "postVar")[1, ,]),
                         cohort = c("1905/1945", 
                                    "1946/1960", 
                                    "1961/1970",
                                    "1971/1980",
                                    "1981/2001"))
period_eff_autho$upper <- period_eff_autho$est_autho + 1.96 * period_eff_autho$se
period_eff_autho$lower <- period_eff_autho$est_autho - 1.96 * period_eff_autho$se
cohort_eff_autho$upper <- cohort_eff_autho$est_autho + 1.96 * cohort_eff_autho$se
cohort_eff_autho$lower <- cohort_eff_autho$est_autho - 1.96 * cohort_eff_autho$se

pr_cohort_autho <- ggplot(cohort_eff_autho,aes(x = cohort,y = est_autho)) +
  geom_point() +
  geom_errorbar(aes(ymin = lower,ymax = upper),width = .2) +
  geom_hline(
    yintercept = 0,
    linetype = 2,
    colour = "grey60",
  ) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  xlab("Cohort") + 
  ylab("The cohort effect of Authority") 
pr_cohort_autho

plot_cohort_autho <- ggarrange(
  pr_cohort_autho,
  pf_cohort_autho
)
plot_cohort_autho
```

## Year_effect
```{r}
#| label: authority
fm1_period_autho <- broom::tidy(fm_autho) %>%
  filter(grepl("^year.",term)) %>%
  rename(
    est = estimate,
    se = std.error,
    Period = term
  ) %>%
  mutate(
    upper = est + 1.96 * se,
    lower = est - 1.96 * se
  )
fm1_period_autho$Period <- gsub("^year", "",fm1_period_autho$Period)

pf_period_autho <- ggplot(fm1_period_autho, aes(x = Period, y = est)) +
  geom_point() + 
  geom_errorbar(aes(ymin = lower, ymax = upper), width = .15) + 
  scale_y_continuous(limits = c(-.8,.8)) +
  geom_hline(
    yintercept = 0,
    colour = "grey60",
    linetype = 2) +
  xlab("Period") + 
  ylab("The Period effect of Authority")
pf_period_autho

pr_period_autho <- ggplot(period_eff_autho,aes(x = as.factor(period),y = est_autho)) +
  geom_point() +
  geom_errorbar(aes(ymin = lower,ymax = upper),width = .2) +
  geom_hline(
    yintercept = 0,
    linetype = 2,
    colour = "grey60",
  ) + 
  scale_y_continuous(limits = c(-.8,.8)) +
  xlab("Period") + 
  ylab("The Period effect of Authority") +
  ggtitle("The Results of Multilevel Regression")
pr_period_autho

plot_period_autho <- ggarrange(
  pr_period_autho,
  pf_period_autho
)
plot_period_autho

plot_autho_FE <- ggarrange(
  pf_cohort_autho,
  pf_period_autho
)
plot_autho_FE
```

# Economic persive

## cohort effect
```{r}
#| label: persive
fm_country <- update(fm_concept, ecocountry ~ .)
fm_country5 <- update(fm_concept, ecocountry5 ~ .)
fm_family <- update(fm_concept, ecofamily ~ .)
fm_family5 <- update(fm_concept, ecofamily5 ~ .)

fm_cohort_country <- broom::tidy(fm_country) %>%
  filter(grepl("^as.",term)) %>%
  rename(
    est = estimate,
    se = std.error,
    cohort = term
  ) %>%
  mutate(
    upper = est + 1.96 * se,
    lower = est - 1.96 * se
  )
fm_cohort_country$cohort <- gsub("^(as.factor)", "",fm_cohort_country$cohort)

pf_cohort_country <- ggplot(fm_cohort_country, aes(x = cohort, y = est)) +
  geom_point() + 
  geom_errorbar(aes(ymin = lower, ymax = upper), width = .15) + 
  # scale_y_continuous(limits = c(-.8,.8)) +
  geom_hline(
    yintercept = 0,
    colour = "grey60",
    linetype = 2) +
  xlab("Cohort") + 
  ylab("The cohort effect of Eco_country")
pf_cohort_country


fm_cohort_country5 <- broom::tidy(fm_country5) %>%
  filter(grepl("^as.",term)) %>%
  rename(
    est = estimate,
    se = std.error,
    cohort = term
  ) %>%
  mutate(
    upper = est + 1.96 * se,
    lower = est - 1.96 * se
  )
fm_cohort_country5$cohort <- gsub("^(as.factor)", "",fm_cohort_country5$cohort)

pf_cohort_country5 <- ggplot(fm_cohort_country5, aes(x = cohort, y = est)) +
  geom_point() + 
  geom_errorbar(aes(ymin = lower, ymax = upper), width = .15) + 
  scale_y_continuous(limits = c(-.8,.8)) +
  geom_hline(
    yintercept = 0,
    colour = "grey60",
    linetype = 2) +
  xlab("Cohort") + 
  ylab("The cohort effect of Eco_country5")
pf_cohort_country5


fm_cohort_family <- broom::tidy(fm_family) %>%
  filter(grepl("^as.",term)) %>%
  rename(
    est = estimate,
    se = std.error,
    cohort = term
  ) %>%
  mutate(
    upper = est + 1.96 * se,
    lower = est - 1.96 * se
  )
fm_cohort_family$cohort <- gsub("^(as.factor)", "",fm_cohort_family$cohort)

pf_cohort_family <- ggplot(fm_cohort_family, aes(x = cohort, y = est)) +
  geom_point() + 
  geom_errorbar(aes(ymin = lower, ymax = upper), width = .15) + 
  scale_y_continuous(limits = c(-.5,.5)) +
  geom_hline(
    yintercept = 0,
    colour = "grey60",
    linetype = 2) +
  xlab("Cohort") + 
  ylab("The cohort effect of Eco_family")
pf_cohort_family


fm_cohort_family5 <- broom::tidy(fm_family5) %>%
  filter(grepl("^as.",term)) %>%
  rename(
    est = estimate,
    se = std.error,
    cohort = term
  ) %>%
  mutate(
    upper = est + 1.96 * se,
    lower = est - 1.96 * se
  )
fm_cohort_family5$cohort <- gsub("^(as.factor)", "",fm_cohort_family5$cohort)

pf_cohort_family5 <- ggplot(fm_cohort_family5, aes(x = cohort, y = est)) +
  geom_point() + 
  geom_errorbar(aes(ymin = lower, ymax = upper), width = .15) + 
  scale_y_continuous(limits = c(-.5,.5)) +
  geom_hline(
    yintercept = 0,
    colour = "grey60",
    linetype = 2) +
  xlab("Cohort") + 
  ylab("The cohort effect of Eco_family5")
pf_cohort_family5

```



## year effect
```{r}
fm_period_country <- broom::tidy(fm_country) %>%
  filter(grepl("^year.",term)) %>%
  rename(
    est = estimate,
    se = std.error,
    Period = term
  ) %>%
  mutate(
    upper = est + 1.96 * se,
    lower = est - 1.96 * se
  )
fm_period_country$Period <- gsub("^year", "",fm_period_country$Period)

pf_period_country <- ggplot(fm_period_country, aes(x = Period, y = est)) +
  geom_point() + 
  geom_errorbar(aes(ymin = lower, ymax = upper), width = .15) + 
  # scale_y_continuous(limits = c(-.8,.8)) +
  geom_hline(
    yintercept = 0,
    colour = "grey60",
    linetype = 2) +
  xlab("Period") + 
  ylab("The Period effect of Authority")
pf_period_country


```

# Regression

## wvs
```{r}
fulldata_wvs <- wvs_china %>%
  left_join(mds_china,by = join_by(yearbirth == year)) %>%
  group_by(cohort) %>%
  mutate(gdppc_mean = mean(gdppc,na.rm = TRUE),
         gdp_mean = mean(gdp,na.rm = TRUE),
         growth_mean = mean(growth,na.rm = TRUE)) %>%
  ungroup()

gdppc2demscore <- lm(demscore ~ log(gdppc_mean)  + age + gender + edu  + interstpol + marriage + socialLevel  + proud, data = fulldata_wvs)
gdppc2diff <- update(gdppc2demscore,diffpro2uti ~ .)

list_eco2dem <- list(
  gdppc2demscore = gdppc2demscore,
  gdppc2diff = gdppc2diff
)

msummary(list_eco2dem,
         stars = TRUE)
```


### concept2level
```{r}
diff2level <- lm(demlevel ~ demdiff + age +)
```



## cbs
### autho
#### gppc_mean's effect
```{r}
# cbs <- read_csv("../data/cbs.csv",show_col_types = FALSE)
fulldata_cbs <- cbs %>%
  left_join(.,mds_china,by = join_by(yearbirth == year)) %>%
  group_by(cohort) %>%
  mutate(gdppc_mean = mean(gdppc,na.rm = TRUE),
         gdp_mean = mean(gdp,na.rm = TRUE),
         growth_mean = mean(growth,na.rm = TRUE)) %>%
  ungroup()

gdppc2autho_mean <- lm(autho ~ log(gdppc_mean) + age + socialLevel +female + edu + hukouRural + interstpol + frepol + marriage + party, data = fulldata_cbs,weights = weight)
ic5_gdppc2autho <- lm(autho ~ log(gdppc_mean) *  ecocountry5 + age + socialLevel +female + edu + hukouRural + interstpol + frepol + marriage + party, data = fulldata_cbs,weights = weight)
ic_gdppc2autho <- update(ic5_gdppc2autho, . ~ . - log(gdppc_mean) *  ecocountry5 + log(gdppc_mean) *  ecocountry)
if5_gdppc2autho <- update(ic5_gdppc2autho, . ~ . - log(gdppc_mean) *  ecocountry5 + log(gdppc_mean) *  ecofamily5)
if_gdppc2autho <- update(ic5_gdppc2autho, . ~ . - log(gdppc_mean) *  ecocountry5 + log(gdppc_mean) *  ecofamily)


list_gdppc2author_mean <- list(
  gdppc2autho_mean = gdppc2autho_mean,
  if5_gdppc2autho = if5_gdppc2autho,
  ic5_gdppc2autho = ic5_gdppc2autho,
  if_gdppc2autho = if_gdppc2autho,
  ic_gdppc2autho = ic_gdppc2autho
)

msummary(list_eco2author,
         stars = TRUE)
```


#### gdppc's effect
```{r}
gdppc2autho <- update(gdppc2autho_mean, . ~. - log(gdppc_mean) + log(gdppc))
ic5_gdppc2autho  <- lm(autho ~ log(gdppc) *  ecocountry5 + age + socialLevel +female + edu + hukouRural + interstpol + frepol + marriage + party, data = fulldata_cbs,weights = weight)
ic_gdppc2autho <- update(ic5_gdppc2autho, . ~ . - log(gdppc) *  ecocountry5 + log(gdppc) *  ecocountry)
if5_gdppc2autho <- update(ic5_gdppc2autho, . ~ . - log(gdppc) *  ecocountry5 + log(gdppc) *  ecofamily5)
if_gdppc2autho <- update(ic5_gdppc2autho, . ~ . - log(gdppc) *  ecocountry5 + log(gdppc) *  ecofamily)

list_gdppc2author <- list(
  gdppc2autho = gdppc2autho,
  ic5_gdppc2autho = ic5_gdppc2autho,
  ic_gdppc2autho = ic_gdppc2autho,
  if5_gdppc2autho = if5_gdppc2autho,
  if_gdppc2autho = if_gdppc2autho
)

msummary(list_gdppc2author,
         stars = TRUE)

```


#### gdp's efect
```{r}
gdp2autho <- update(gdppc2autho_mean, . ~ . - log(gdppc_mean) + log(gdp_mean))
ic5_gdp2autho <- lm(autho ~ log(gdp_mean) *  ecocountry5 + age + socialLevel +female + edu + hukouRural + interstpol + frepol + marriage + party, data = fulldata_cbs,weights = weight)
ic_gdp2autho <- update(ic5_gdp2autho, . ~ . - log(gdp_mean) *  ecocountry5 + log(gdp_mean) *  ecocountry)
if5_gdp2autho <- update(ic5_gdp2autho, . ~ . - log(gdp_mean) *  ecocountry5 + log(gdp_mean) *  ecofamily5)
if_gdp2autho <- update(ic5_gdp2autho, . ~ . - log(gdp_mean) *  ecocountry5 + log(gdp_mean) *  ecofamily)


list_gdp2author <- list(
  gdp2autho = gdp2autho,
  ic5_gdp2autho = ic5_gdp2autho,
  ic_gdp2autho = ic_gdp2autho,
  if5_gdp2autho = if5_gdp2autho,
  if_gdp2autho = if_gdp2autho
)

msummary(list_gdp2author,
         stars = TRUE)
```






#### medaition/inter

```{r}
#| label: no effect
#| eval: false
ipcf5 <- lm(leader ~ log(gdppc) * ecofamily5  + + age + socialLevel + female + edu + hukouRural + interstpol  + marriage + party, data = fulldata_cbs,weights = weight)
ipcf <- update(ipcf5, . ~ . - log(gdppc) * ecofamily5 + log(gdppc) * ecofamily)
ipcc5 <- update(ipcf5, . ~ . - log(gdppc) * ecofamily5 + log(gdppc) * ecocountry5)
ipcc <- update(ipcf5, . ~ . - log(gdppc) * ecofamily5 + log(gdppc) * ecocountry)

list_mpc <- list(
  ipcf5 = ipcf5,
  ipcf = ipcf,
  ipcc5 = ipcc5,
  ipcc = ipcc
)

msummary(list_mpc,
         stars = TRUE)
## 只有国家5年前为正，家庭没影响，国家现在为负。


## total effect
mpc2au_c5 <- update(mpc2c5, autho ~ . + ecocountry5)
```

### leader
```{r}
pc2l <- update(gdppc2autho_mean, leader ~ .)
dp2l <- update(pc2l,.~. -log(gdppc_mean) + log(gdp_mean))

ic_pc2l <- lm(leader ~ lag(log(gdppc),1) * ecofamily + age + socialLevel + female + edu + hukouRural + frepol + marriage + party, data = fulldata_cbs,weights = weight)
ic5_pc2l <- update(ic_pc2l, . ~ .  - lag(log(gdppc),1) * ecofamily + lag(log(gdppc),1) * ecofamily5)
if_pc2l <- update(ic_pc2l, . ~ . - lag(log(gdppc),1) * ecofamily + lag(log(gdppc),1) * ecocountry5)
if5_pc2l <- update(ic_pc2l, . ~ . - lag(log(gdppc),1) * ecofamily + lag(log(gdppc),1) * ecocountry)


mlead <- list(
  ic_pc2l = ic_pc2l,
  ic5_pc2l = ic5_pc2l,
  if_pc2l = if_pc2l,
  if5_pc2l = if5_pc2l
)

msummary(mlead,
         stars = TRUE)
```

